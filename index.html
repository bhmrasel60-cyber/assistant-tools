<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // মেসেজিং সার্ভিস ইমপোর্ট করা হলো
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    const myConfig = {
        apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
        authDomain: "mywebtools-f8d53.firebaseapp.com",
        projectId: "mywebtools-f8d53",
        storageBucket: "mywebtools-f8d53.firebasestorage.app",
        messagingSenderId: "979594414301",
        appId: "1:979594414301:web:7048c995e56e331a85f334",
        measurementId: "G-44SNF7BWXK"
    };

    const VAPID_KEY = "BOVXtUUCRy2p5-QqB1orahGTjdc1FGVIMJBf76hArZMnoWAtTpFodxPs1FjyX1gefbKB08RTUUbqDit2XeKc0DU";
    const SECRET_PASS = "rasel123";
    const SYNC_APP_ID = "rasel-mia-universal-sync"; 
    let lastSeenTs = localStorage.getItem('global_notif_ts') || '0';
    let latestData = null;

    const app = initializeApp(myConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    // Push Notification Token Setup
    async function requestPermission() {
        console.log('Requesting permission...');
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            try {
                const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                if (token) {
                    console.log('Token generated:', token);
                    // আপনি চাইলে এই টোকেনটি ডাটাবেসে সেভ করতে পারেন স্পেসিফিক ইউজারকে পাঠানোর জন্য
                } else {
                    console.log('No registration token available. Request permission to generate one.');
                }
            } catch (err) {
                console.log('An error occurred while retrieving token. ', err);
            }
        } else {
            console.log('Unable to get permission to notify.');
        }
    }

    // Anonymous login for users
    signInAnonymously(auth).then(() => {
        requestPermission(); // লগইন হওয়ার পর পারমিশন চাওয়া হবে
    }).catch(err => {
        console.error("Auth Error:", err);
        document.getElementById('sync-text').innerText = "Auth Failed";
    });

    onAuthStateChanged(auth, (user) => {
        if (!user) return;
        
        document.getElementById('sync-text').innerText = "Sync: Live";
        document.getElementById('sync-dot').querySelector('span:last-child').classList.replace('bg-pink-500', 'bg-emerald-500');

        const docRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'broadcast', 'current');
        onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                latestData = data;
                document.getElementById('ticker-text').innerHTML = `${data.message} &nbsp;&bull;&nbsp; Global Active.`;
                
                if (data.timestamp > lastSeenTs) {
                    showUIPopup(data.message);
                }
            }
        });
    });

    // Foreground Message Handling
    onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        showUIPopup(payload.notification.body);
    });

    function showUIPopup(msg) {
        document.getElementById('popup-text').innerText = msg;
        document.getElementById('global-popup').classList.remove('hidden');
        
        if (Notification.permission === "granted") {
            new Notification("Rasel's Broadcaster", {
                body: msg,
                icon: "developer.jpg"
            });
        }
    }

    // Admin Send Button
    document.getElementById('send-btn').onclick = async () => {
        const pass = document.getElementById('admin-pass').value;
        const msg = document.getElementById('admin-msg').value.trim();
        
        if (pass !== SECRET_PASS) { 
            alert("Wrong Password!"); 
            return; 
        }
        if (!msg) return;

        const docRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'broadcast', 'current');
        try {
            await setDoc(docRef, { 
                message: msg, 
                timestamp: Date.now().toString(), 
                sender: "Rasel Mia" 
            });
            closeAdminModal();
            document.getElementById('admin-pass').value = '';
            document.getElementById('admin-msg').value = '';
        } catch (error) {
            alert("Error sending message.");
        }
    };

    window.openAdminModal = () => document.getElementById('admin-modal').classList.remove('hidden');
    window.closeAdminModal = () => document.getElementById('admin-modal').classList.add('hidden');
    window.dismissPopup = () => {
        if (latestData) {
            localStorage.setItem('global_notif_ts', latestData.timestamp);
            lastSeenTs = latestData.timestamp;
        }
        document.getElementById('global-popup').classList.add('hidden');
    };
</script>
