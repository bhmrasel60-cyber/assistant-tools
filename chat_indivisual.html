<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Nexus Messenger | Secure P2P Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        /* üî• Premium Dark Glassmorphism Theme üî• */
        html, body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            margin: 0;
            padding: 0;
            position: fixed; 
            top: 0;
            left: 0;
            touch-action: none;
        }
        
        /* Dark Cubes Background */
        .chat-bg {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            background-color: #0f172a;
            background-blend-mode: overlay;
            opacity: 0.95;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .msg-bubble { animation: popIn 0.2s ease-out forwards; }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }
        
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        textarea, input { font-size: 16px !important; } 
        
        .contact-active { background: linear-gradient(to right, rgba(236, 72, 153, 0.15), transparent); border-left: 4px solid #ec4899; }

        audio { height: 40px; outline: none; border-radius: 20px; width: 100%; }
        audio::-webkit-media-controls-panel { background-color: rgba(255, 255, 255, 0.9); }
        
        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; animation: popIn 0.15s ease-out forwards; }

        /* Custom Audio Player */
        .audio-slider {
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            height: 4px;
            border-radius: 5px;
            outline: none;
        }
        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="flex selection:bg-pink-500/30">

    <!-- Sound Effects -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="ringtone-sound" src="https://assets.mixkit.co/active_storage/sfx/2803/2803-preview.mp3" preload="auto" loop></audio>

    <!-- Fullscreen Image Lightbox -->
    <div id="image-lightbox" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-md transition-opacity opacity-0" onclick="closeLightbox()">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 md:top-8 md:right-8 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white text-xl hover:bg-pink-500 transition-colors z-50">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain p-2 md:p-8 transform scale-95 transition-transform duration-300 shadow-2xl rounded-xl">
    </div>

    <!-- Registration Modal -->
    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-lg transition-opacity">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl text-center transform scale-100 transition-transform relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 to-purple-600"></div>
            <div class="w-20 h-20 bg-gradient-to-br from-pink-500 to-purple-600 rounded-2xl flex items-center justify-center mb-6 mx-auto shadow-lg shadow-pink-500/30 transform rotate-3">
                <i class="fa-solid fa-paper-plane text-3xl text-white -rotate-3"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-white tracking-tight">Nexus Messenger</h2>
            <p class="text-slate-400 text-sm mb-8 font-medium">Secure and unified private chat.</p>
            
            <form id="join-form" class="space-y-4">
                <input type="text" id="reg-name" required autocomplete="off" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold text-base shadow-inner" placeholder="Your Name">
                <input type="tel" id="reg-mobile" required autocomplete="off" pattern="[0-9]{11}" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-purple-500 transition-all font-bold tracking-widest text-base shadow-inner" placeholder="Mobile Number (11 digits)">
                
                <button type="submit" id="join-btn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 py-4 rounded-2xl text-white font-black uppercase tracking-widest transition-all shadow-lg active:scale-95 text-sm mt-4">Connect Securely</button>
            </form>
            <div class="mt-6">
                <a href="index.html" class="text-xs text-slate-500 hover:text-white font-medium underline transition-colors">Back to Dashboard</a>
            </div>
        </div>
    </div>

    <!-- PROFILE SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md transition-opacity">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl text-center relative">
            <button onclick="closeSettings()" class="absolute top-5 right-5 w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 text-white flex items-center justify-center transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 class="text-xl font-black mb-6 text-white uppercase tracking-wider">Profile Settings</h2>

            <div class="relative w-32 h-32 mx-auto mb-6 group cursor-pointer" onclick="document.getElementById('profile-pic-input').click()">
                <img id="settings-avatar-preview" src="" class="w-full h-full rounded-[2rem] object-cover group-hover:opacity-60 transition-opacity bg-slate-800 shadow-lg border-2 border-white/10">
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-[2rem] bg-black/50">
                    <i class="fa-solid fa-camera text-3xl text-white"></i>
                </div>
            </div>
            <input type="file" id="profile-pic-input" accept="image/*" class="hidden" onchange="previewProfilePic(event)">

            <div class="mb-6 text-left">
                <label class="text-pink-400 text-xs font-bold uppercase tracking-widest mb-2 block ml-1">Display Name</label>
                <div class="flex items-center bg-black/40 rounded-2xl border border-white/10 px-4 py-2 focus-within:border-pink-500 transition-colors">
                    <input type="text" id="settings-name-input" class="w-full bg-transparent p-2 text-white focus:outline-none text-base font-bold" placeholder="Enter your name">
                    <i class="fa-solid fa-pen text-slate-500 text-sm"></i>
                </div>
            </div>

            <button id="save-settings-btn" onclick="saveProfileSettings()" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 py-4 rounded-2xl text-white font-bold uppercase tracking-widest transition-all flex items-center justify-center gap-2 shadow-lg shadow-pink-500/30">
                <i class="fa-solid fa-check"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden absolute top-0 left-0 w-full max-w-[1600px] mx-auto md:py-4 md:px-4" style="height: 100%;">
        <div class="w-full h-full flex bg-slate-900/50 shadow-2xl md:rounded-[2rem] border border-white/5 overflow-hidden relative backdrop-blur-md">
            
            <!-- LEFT SIDEBAR (Contacts) -->
            <div id="sidebar" class="w-full md:w-[380px] lg:w-[420px] flex flex-col border-r border-white/5 glass-panel z-20 flex-shrink-0 absolute md:relative inset-0 md:inset-auto">
                <header class="p-4 bg-black/20 flex items-center justify-between shrink-0 border-b border-white/5" style="padding-top: max(1rem, env(safe-area-inset-top));">
                    <div class="flex items-center gap-3">
                        <img id="my-avatar" src="" onclick="openSettings()" class="w-11 h-11 rounded-[1rem] object-cover cursor-pointer hover:opacity-80 transition-opacity border border-white/10 shadow-md bg-slate-800" title="Profile Settings">
                        <div class="hidden md:block">
                            <h2 id="my-name-display" class="font-bold text-white text-sm">My Profile</h2>
                            <p class="text-[10px] text-pink-400 font-bold tracking-widest uppercase">Active Now</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-slate-300">
                        <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-pink-600 hover:text-white transition-colors" title="Home">
                            <i class="fa-solid fa-house text-sm"></i>
                        </a>
                        <button onclick="openSettings()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-pink-600 hover:text-white transition-colors" title="Settings">
                            <i class="fa-solid fa-gear text-sm"></i>
                        </button>
                        <button onclick="logoutPvtChat()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-colors" title="Logout">
                            <i class="fa-solid fa-right-from-bracket text-sm"></i>
                        </button>
                    </div>
                </header>

                <div class="p-3 bg-black/10 shrink-0">
                    <div class="bg-black/30 rounded-2xl flex items-center px-4 py-3 border border-white/5 focus-within:border-pink-500/50 transition-colors shadow-inner">
                        <i class="fa-solid fa-magnifying-glass text-slate-500 text-sm"></i>
                        <input type="text" id="search-input" placeholder="Search contacts..." class="bg-transparent border-none outline-none text-white text-sm w-full ml-3 placeholder-slate-500 font-medium">
                    </div>
                </div>

                <div id="contacts-list" class="flex-grow overflow-y-auto custom-scroll relative" style="touch-action: pan-y;">
                    <div class="text-center py-3 text-[10px] text-slate-500 font-bold uppercase tracking-widest sticky top-0 bg-slate-900/95 backdrop-blur-md z-10 border-b border-white/5 flex justify-between items-center px-6">
                        <span>All Contacts</span>
                        <i class="fa-solid fa-users text-pink-500/50"></i>
                    </div>
                    <div id="contacts-container" class="pb-6"></div>
                </div>
            </div>

            <!-- RIGHT SIDEBAR (Chat Window) -->
            <div id="chat-area" class="w-full hidden flex-col relative h-full bg-slate-950/50">
                
                <div id="empty-chat-state" class="absolute inset-0 z-40 flex flex-col items-center justify-center chat-bg backdrop-blur-sm border-l border-white/5">
                    <div class="w-28 h-28 bg-gradient-to-br from-pink-500/10 to-purple-600/10 rounded-[2rem] flex items-center justify-center mb-6 border border-pink-500/20 shadow-xl transform rotate-3">
                        <i class="fa-solid fa-bolt-lightning text-5xl text-pink-400 -rotate-3"></i>
                    </div>
                    <h2 class="text-3xl font-black text-white mb-3 tracking-tight">Nexus Chat Suite</h2>
                    <p class="text-slate-400 text-sm max-w-sm text-center px-4 font-medium leading-relaxed">Select a contact to start an encrypted conversation. Experience seamless messaging.</p>
                    <div class="mt-8 bg-black/40 border border-white/5 px-4 py-2 rounded-full text-xs text-slate-400 flex items-center gap-2 font-bold">
                        <i class="fa-solid fa-shield-halved text-emerald-500"></i> P2P Encryption Active
                    </div>
                </div>

                <header class="p-3 md:p-4 bg-black/20 flex items-center justify-between shrink-0 relative z-30 border-b border-white/10 shadow-md" style="padding-top: max(0.5rem, env(safe-area-inset-top));">
                    <div class="flex items-center gap-3">
                        <button onclick="closeChatMobile()" class="md:hidden w-10 h-10 flex items-center justify-center rounded-xl text-slate-300 hover:bg-white/10 shrink-0 transition-colors bg-white/5 border border-white/10">
                            <i class="fa-solid fa-arrow-left text-sm"></i>
                        </button>
                        <div class="flex items-center gap-3 cursor-pointer">
                            <img id="active-chat-avatar" src="" class="w-11 h-11 md:w-12 md:h-12 rounded-[1rem] object-cover border border-white/10 shadow-sm bg-slate-800">
                            <div class="flex flex-col justify-center">
                                <h2 id="active-chat-name" class="font-bold text-white text-base leading-tight">Contact Name</h2>
                                <p id="active-chat-status" class="text-[11px] text-pink-400 font-bold tracking-widest uppercase mt-0.5">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 text-slate-300 relative pr-2">
                        <button onclick="startCall('video')" class="w-11 h-11 rounded-xl bg-white/5 border border-white/10 hover:bg-pink-600 hover:text-white transition-all shadow-sm text-pink-400"><i class="fa-solid fa-video text-sm"></i></button>
                        <button onclick="startCall('audio')" class="w-11 h-11 rounded-xl bg-white/5 border border-white/10 hover:bg-emerald-600 hover:text-white transition-all shadow-sm text-emerald-400"><i class="fa-solid fa-phone text-sm"></i></button>
                        <button onclick="toggleChatMenu(event)" class="w-11 h-11 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-colors"><i class="fa-solid fa-ellipsis-vertical text-sm"></i></button>
                        <div id="chat-dropdown" class="dropdown-menu absolute top-14 right-2 bg-slate-800 border border-white/10 rounded-2xl shadow-xl py-2 w-48 z-50 overflow-hidden">
                            <button onclick="clearEntireChat()" class="w-full text-left px-5 py-3 text-sm text-red-400 hover:bg-red-500/20 transition-colors flex items-center gap-3 font-bold">
                                <i class="fa-solid fa-trash-can w-4 text-center"></i> Clear Chat
                            </button>
                        </div>
                    </div>
                </header>

                <main id="messages-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-6 flex flex-col gap-2 custom-scroll relative z-20" onclick="closeAllMenus()" style="touch-action: pan-y;">
                    <div class="text-center my-4">
                        <span class="bg-black/60 text-slate-300 text-[10px] px-4 py-1.5 rounded-full border border-white/10 uppercase tracking-widest font-bold backdrop-blur-md shadow-sm">
                            <i class="fa-solid fa-shield-halved text-pink-400 mr-1"></i> End-to-end encrypted
                        </span>
                    </div>
                </main>

                <footer class="p-3 md:p-4 glass-panel shrink-0 border-t border-white/5 z-30 relative" style="padding-bottom: max(0.75rem, env(safe-area-inset-bottom));">
                    <div id="file-preview-container" class="hidden w-full px-1 mb-3">
                        <div class="bg-slate-800/80 backdrop-blur-md border border-white/10 rounded-2xl p-3 flex items-center justify-between shadow-lg">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div id="preview-icon-wrapper" class="w-12 h-12 rounded-xl bg-pink-500/20 text-pink-400 flex items-center justify-center shrink-0 border border-pink-500/30 overflow-hidden relative">
                                    <i id="preview-icon" class="fa-solid fa-file text-xl"></i>
                                    <img id="preview-img" src="" class="hidden w-full h-full object-cover absolute inset-0">
                                </div>
                                <div class="overflow-hidden">
                                    <p id="file-preview-name" class="text-sm font-bold text-white truncate w-48 md:w-72">filename</p>
                                    <p id="file-preview-size" class="text-[10px] text-slate-400 uppercase tracking-widest mt-0.5">0 MB</p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFile()" class="text-slate-400 hover:text-red-400 w-10 h-10 flex items-center justify-center rounded-full transition-colors bg-white/5 border border-white/5 shadow-sm">
                                <i class="fa-solid fa-xmark text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div id="recording-ui" class="hidden flex items-center justify-between bg-red-500/10 border border-red-500/20 rounded-2xl p-2 mb-3 animate-pulse shadow-sm">
                        <div class="flex items-center gap-3 text-red-400 pl-4 font-bold text-sm">
                            <i class="fa-solid fa-microphone-lines animate-bounce text-lg"></i> Recording Audio...
                        </div>
                        <div class="flex gap-2 pr-1">
                            <button type="button" onclick="cancelRecording()" class="w-10 h-10 rounded-xl bg-slate-800 border border-white/10 text-slate-300 hover:text-red-400 flex items-center justify-center transition-colors shadow-sm">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button type="button" onclick="stopAndSendRecording()" class="w-10 h-10 rounded-xl bg-gradient-to-r from-pink-600 to-purple-600 text-white hover:opacity-90 flex items-center justify-center shadow-lg shadow-pink-500/30 transition-all">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <form id="chat-form" class="flex items-end gap-2 w-full relative">
                        <button type="button" onclick="document.getElementById('file-input').click()" class="w-12 h-12 shrink-0 text-slate-300 hover:text-pink-400 bg-white/5 hover:bg-white/10 rounded-2xl flex items-center justify-center transition-all border border-white/10 mb-0.5 shadow-sm">
                            <i class="fa-solid fa-paperclip text-lg"></i>
                        </button>
                        <input type="file" id="file-input" class="hidden">

                        <div class="flex-grow bg-black/40 border border-white/10 rounded-3xl flex items-center px-4 py-1.5 transition-all focus-within:border-pink-500 focus-within:ring-2 focus-within:ring-pink-500/20 relative shadow-inner">
                            <textarea id="msg-input" rows="1" placeholder="Type a message..."
                                class="w-full bg-transparent py-2 text-white focus:outline-none resize-none max-h-32 custom-scroll text-[15px] placeholder-slate-500 font-medium" style="min-height: 40px;"></textarea>
                        </div>
                        
                        <button type="button" id="mic-btn" onclick="startRecording()" class="w-12 h-12 shrink-0 bg-gradient-to-r from-pink-600 to-purple-600 hover:opacity-90 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-pink-500/30 transition-all active:scale-95 mb-0.5">
                            <i class="fa-solid fa-microphone text-lg"></i>
                        </button>
                        
                        <button type="submit" id="send-btn" class="hidden w-12 h-12 shrink-0 bg-gradient-to-r from-pink-600 to-purple-600 hover:opacity-90 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-pink-500/30 transition-all active:scale-95 mb-0.5">
                            <i class="fa-solid fa-paper-plane text-lg ml-[-2px]"></i>
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    </div>

    <!-- üî• CALL MODAL üî• -->
    <div id="call-modal" class="hidden fixed inset-0 z-[300] bg-slate-950 overflow-hidden flex-col">
        <audio id="remote-audio" autoplay playsinline></audio>
        <video id="remote-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover hidden z-0 bg-black"></video>
        <video id="local-video" autoplay playsinline muted class="absolute top-12 right-4 md:top-8 md:right-8 w-28 h-40 md:w-40 md:h-56 bg-slate-800 rounded-2xl border-2 border-white/20 object-cover hidden z-20 shadow-2xl"></video>

        <div id="call-overlay" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-950/90 backdrop-blur-xl transition-opacity duration-500">
            <div class="relative mb-8">
                <img id="call-avatar" src="" class="w-32 h-32 rounded-[2rem] object-cover z-10 relative border-4 border-pink-500 shadow-2xl shadow-pink-500/50">
                <div class="absolute inset-0 border-4 border-pink-500 rounded-[2rem] animate-ping opacity-40 z-0"></div>
            </div>
            <h2 id="call-name" class="text-3xl font-black text-white mb-2 tracking-tight">Caller Name</h2>
            <p id="call-status" class="text-pink-400 text-sm font-bold tracking-widest uppercase mb-12">Calling...</p>
        </div>
        
        <div class="absolute bottom-10 md:bottom-12 left-1/2 -translate-x-1/2 flex items-center justify-center gap-6 z-30 w-full px-4">
            <button id="answer-btn" onclick="answerCall()" class="hidden w-16 h-16 rounded-full bg-emerald-600 text-white text-2xl hover:bg-emerald-500 hover:scale-110 transition-all shadow-lg shadow-emerald-600/40 flex items-center justify-center">
                <i class="fa-solid fa-phone"></i>
            </button>
            <div id="in-call-controls" class="hidden flex items-center gap-3 bg-slate-900/80 backdrop-blur-lg p-2.5 rounded-full border border-white/10 shadow-2xl">
                <button id="mic-toggle-btn" onclick="toggleMic()" class="w-12 h-12 rounded-full bg-white/10 text-white text-lg hover:bg-white/20 transition-colors shadow-inner">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <button id="cam-toggle-btn" onclick="toggleCamera()" class="w-12 h-12 rounded-full bg-white/10 text-white text-lg hover:bg-white/20 transition-colors hidden shadow-inner">
                    <i class="fa-solid fa-video"></i>
                </button>
                <div class="w-[1px] h-8 bg-white/10 mx-1"></div>
                <button id="hangup-btn" onclick="hangupCall()" class="w-14 h-14 rounded-full bg-red-600 text-white text-xl hover:bg-red-500 hover:scale-110 transition-all shadow-lg shadow-red-600/40 flex items-center justify-center">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
            <button id="caller-hangup-btn" onclick="hangupCall()" class="hidden w-16 h-16 rounded-full bg-red-600 text-white text-2xl hover:bg-red-400 hover:scale-110 transition-all shadow-lg shadow-red-600/40 flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appStartTime = Date.now();
        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };
        const SYNC_APP_ID = "rasel-mia-universal-sync";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myName = localStorage.getItem('pvt_chat_name') || '';
        let myMobile = localStorage.getItem('pvt_chat_mobile') || '';
        let myAvatarUrl = localStorage.getItem('pvt_chat_avatar') || ''; 
        let activeContactMobile = null;
        let allUsers = [];
        let latestMessages = {}; 
        let chatListeners = {};  
        let currentChatUnsubscribe = null;
        let userStatusUnsubscribe = null;
        let selectedFile = null;
        let typingTimeout = null; 
        let mediaRecorder, audioChunks = [], isRecording = false, settingsSelectedFile = null;
        
        // WebRTC Setup (Module error fixed - all code kept inline)
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };
        let pc = null, localStream = null, incomingCallData = null, currentCallId = null, remoteDescriptionSet = false, iceCandidateQueue = [];

        // UI Helpers
        function getAvatarUrl(name, customUrl) { return customUrl ? customUrl : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ec4899&color=fff&bold=true`; }
        function formatTime(seconds) { if(!seconds || isNaN(seconds)) return "0:00"; const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }

        // üî• Service Worker & Background Notif Logic üî•
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('firebase-messaging-sw2.js').catch(e => console.warn("SW not registered", e));
        }

        function triggerSystemNotification(title, body) {
            // Check if permission is granted and tab is hidden
            if ("Notification" in window && Notification.permission === "granted" && document.hidden) {
                if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, { body: body, icon: 'developer.jpg', vibrate: [200, 100, 200] });
                    }).catch(e => {
                        new Notification(title, { body: body, icon: 'developer.jpg' });
                    });
                } else {
                    new Notification(title, { body: body, icon: 'developer.jpg' });
                }
            }
        }

        // Viewport Fix
        function setRealViewportHeight() {
            let vh = window.innerHeight;
            if (window.visualViewport) vh = window.visualViewport.height;
            document.body.style.height = vh + 'px';
            document.documentElement.style.height = vh + 'px';
            
            const appContainer = document.getElementById('app-container');
            if (appContainer) appContainer.style.height = vh + 'px';
            const msgBox = document.getElementById('messages-box');
            if(msgBox) setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 50);
        }
        window.addEventListener('resize', setRealViewportHeight);
        if (window.visualViewport) window.visualViewport.addEventListener('resize', setRealViewportHeight);
        setRealViewportHeight();


        if (myName && myMobile) startApp(); else document.getElementById('join-modal').classList.remove('hidden');

        async function startApp() {
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl);

            // Ask Notification Permission on Login
            if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }

            try {
                await signInAnonymously(auth);
                const myRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile);
                const mySnap = await getDoc(myRef);
                if(mySnap.exists()) {
                    const d = mySnap.data();
                    if(d.avatarUrl) { myAvatarUrl = d.avatarUrl; localStorage.setItem('pvt_chat_avatar', myAvatarUrl); document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl); }
                    if(d.name && d.name !== myName) { myName = d.name; localStorage.setItem('pvt_chat_name', myName); }
                }
                const updateStatus = async () => { await setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { name: myName, mobile: myMobile, lastActive: Date.now() }, { merge: true }); };
                updateStatus(); setInterval(updateStatus, 60000);
                listenForUsers(); listenForIncomingCalls(); 
            } catch (err) {}
        }

        // üî• WebRTC & Calling Engine üî•
        function initializePeerConnection() {
            if (pc) pc.close();
            pc = new RTCPeerConnection(servers);
            remoteDescriptionSet = false; iceCandidateQueue = [];
            const rVid = document.getElementById('remote-video'), rAud = document.getElementById('remote-audio');
            rVid.srcObject = new MediaStream(); rAud.srcObject = new MediaStream();
            pc.ontrack = event => {
                const trk = event.track;
                if (trk.kind === 'video') { rVid.srcObject.addTrack(trk); rVid.classList.remove('hidden'); setTimeout(()=>rVid.play().catch(e=>{}),100); }
                else if (trk.kind === 'audio') { rAud.srcObject.addTrack(trk); setTimeout(()=>rAud.play().catch(e=>{}),100); }
            };
            return pc;
        }

        async function processIceCandidate(candidateData) {
            if (remoteDescriptionSet && pc) { await pc.addIceCandidate(new RTCIceCandidate(candidateData)).catch(e=>{}); }
            else { iceCandidateQueue.push(candidateData); }
        }

        function listenForIncomingCalls() {
            onSnapshot(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls'), (snap) => {
                snap.docChanges().forEach(change => {
                    const callData = change.doc.data();
                    if (change.type === 'added' || change.type === 'modified') {
                        if (callData.callee === myMobile && callData.status === 'calling') {
                            incomingCallData = { id: change.doc.id, ...callData };
                            const caller = allUsers.find(u => u.mobile === callData.caller);
                            document.getElementById('call-modal').classList.remove('hidden');
                            document.getElementById('call-modal').classList.add('flex');
                            document.getElementById('call-name').innerText = "Incoming Call";
                            document.getElementById('call-avatar').src = caller ? getAvatarUrl(caller.name, caller.avatarUrl) : getAvatarUrl("User", "");
                            document.getElementById('call-status').innerText = callData.type === 'video' ? "Video Call Ringing..." : "Voice Call Ringing...";
                            document.getElementById('answer-btn').classList.remove('hidden');
                            document.getElementById('caller-hangup-btn').classList.add('hidden');
                            document.getElementById('in-call-controls').classList.add('hidden');
                            try { document.getElementById('ringtone-sound').play().catch(e=>{}); } catch(e){}
                            
                            // üî• Trigger Background Notification on Call
                            triggerSystemNotification("Incoming Call", `Call from ${caller?.name || 'Contact'}`);
                        }
                        if (callData.status === 'ended' && (currentCallId === change.doc.id || (incomingCallData && incomingCallData.id === change.doc.id))) { resetCallUI(); }
                    }
                });
            });
        }

        window.startCall = async (type) => {
            if(!activeContactMobile) return;
            document.getElementById('call-modal').classList.remove('hidden');
            document.getElementById('call-modal').classList.add('flex');
            document.getElementById('call-name').innerText = document.getElementById('active-chat-name').innerText;
            document.getElementById('call-avatar').src = document.getElementById('active-chat-avatar').src;
            document.getElementById('call-status').innerText = "Calling...";
            document.getElementById('caller-hangup-btn').classList.remove('hidden');
            document.getElementById('call-overlay').classList.remove('opacity-0', 'pointer-events-none');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
                if(type === 'video') { const lV = document.getElementById('local-video'); lV.srcObject = localStream; lV.classList.remove('hidden'); }
                pc = initializePeerConnection();
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                currentCallId = "call_" + (myMobile < activeContactMobile ? myMobile+"_"+activeContactMobile : activeContactMobile+"_"+myMobile) + "_" + Date.now();
                const callRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', currentCallId);
                pc.onicecandidate = e => { if(e.candidate) addDoc(collection(callRef, 'offerCandidates'), e.candidate.toJSON()); };
                const off = await pc.createOffer(); await pc.setLocalDescription(off);
                await setDoc(callRef, { offer: { type: off.type, sdp: off.sdp }, caller: myMobile, callee: activeContactMobile, type, status: 'calling', timestamp: Date.now() });
                pc.callUnsubscribe = onSnapshot(callRef, async (s) => {
                    const d = s.data();
                    if(pc && !remoteDescriptionSet && d?.answer) {
                        await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                        remoteDescriptionSet = true;
                        document.getElementById('call-status').innerText = "Connected";
                        document.getElementById('caller-hangup-btn').classList.add('hidden');
                        document.getElementById('in-call-controls').classList.remove('hidden');
                        if(type === 'video') { document.getElementById('call-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('cam-toggle-btn').classList.remove('hidden'); }
                        for(let c of iceCandidateQueue) await pc.addIceCandidate(new RTCIceCandidate(c)).catch(e=>{});
                        iceCandidateQueue = [];
                        onSnapshot(collection(callRef, 'answerCandidates'), snap => snap.docChanges().forEach(c => { if(c.type === 'added') processIceCandidate(c.doc.data()); }));
                    }
                });
            } catch (err) { alert("Mic/Cam Error: Please grant permissions."); resetCallUI(); }
        };

        window.answerCall = async () => {
            if(!incomingCallData) return;
            document.getElementById('ringtone-sound').pause(); document.getElementById('ringtone-sound').currentTime = 0;
            document.getElementById('call-status').innerText = "Connecting...";
            document.getElementById('answer-btn').classList.add('hidden');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: incomingCallData.type === 'video' });
                if(incomingCallData.type === 'video') { const lV = document.getElementById('local-video'); lV.srcObject = localStream; lV.classList.remove('hidden'); }
                pc = initializePeerConnection();
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                const callRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', incomingCallData.id);
                pc.onicecandidate = e => { if(e.candidate) addDoc(collection(callRef, 'answerCandidates'), e.candidate.toJSON()); };
                await pc.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
                remoteDescriptionSet = true;
                const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                await updateDoc(callRef, { answer: { type: ans.type, sdp: ans.sdp }, status: 'answered' });
                document.getElementById('call-status').innerText = "Connected";
                document.getElementById('in-call-controls').classList.remove('hidden');
                if(incomingCallData.type === 'video') { document.getElementById('call-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('cam-toggle-btn').classList.remove('hidden'); }
                onSnapshot(collection(callRef, 'offerCandidates'), snap => snap.docChanges().forEach(c => { if(c.type === 'added') processIceCandidate(c.doc.data()); }));
            } catch(e) { alert("Connection failed."); resetCallUI(); }
        };

        window.hangupCall = async () => {
            const id = currentCallId || (incomingCallData ? incomingCallData.id : null);
            if(id) await updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', id), { status: 'ended' }).catch(()=>{});
            resetCallUI();
        };

        window.resetCallUI = () => {
            document.getElementById('ringtone-sound').pause(); document.getElementById('ringtone-sound').currentTime = 0;
            document.getElementById('call-modal').classList.remove('flex'); document.getElementById('call-modal').classList.add('hidden');
            document.getElementById('call-overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('local-video').classList.add('hidden'); document.getElementById('remote-video').classList.add('hidden');
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if (pc) { if(pc.callUnsubscribe) pc.callUnsubscribe(); pc.close(); pc = null; }
            incomingCallData = null; currentCallId = null; remoteDescriptionSet = false; iceCandidateQueue = [];
            const rV = document.getElementById('remote-video'), rA = document.getElementById('remote-audio'), lV = document.getElementById('local-video');
            if(rV) rV.srcObject = null; if(rA) rA.srcObject = null; if(lV) lV.srcObject = null;
        };

        // --- Common Chat Logic ---
        function listenForUsers() {
            onSnapshot(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users'), (snapshot) => {
                allUsers = [];
                snapshot.forEach(doc => { const data = doc.data(); if (data.mobile !== myMobile) { allUsers.push(data); setupLastMessageListener(data.mobile); } });
                renderContacts();
            });
        }
        function setupLastMessageListener(contactMobile) {
            if (chatListeners[contactMobile]) return; 
            const chatId = generateChatId(myMobile, contactMobile);
            const q = query(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`), orderBy('timestamp', 'desc'), limit(1));
            chatListeners[contactMobile] = onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const newLatest = snapshot.docs[0].data();
                    const oldLatest = latestMessages[contactMobile];
                    if (newLatest.senderMobile !== myMobile && (!oldLatest || newLatest.timestamp > oldLatest.timestamp) && newLatest.timestamp > appStartTime) {
                        try { document.getElementById('notification-sound').play().catch(e=>{}); } catch(e){}
                        
                        // üî• Trigger Background Notification on Text Message
                        const sender = allUsers.find(u => u.mobile === newLatest.senderMobile);
                        triggerSystemNotification(`New Message from ${sender?.name || 'Contact'}`, newLatest.text || "Sent an attachment");
                    }
                    latestMessages[contactMobile] = newLatest;
                } else { latestMessages[contactMobile] = null; }
                renderContacts();
            });
        }
        function renderContacts() {
            const container = document.getElementById('contacts-container');
            const term = document.getElementById('search-input').value.toLowerCase();
            let filtered = allUsers.filter(u => u.name.toLowerCase().includes(term) || u.mobile.includes(term));
            filtered.sort((a,b) => (latestMessages[b.mobile]?.timestamp || 0) - (latestMessages[a.mobile]?.timestamp || 0));
            container.innerHTML = '';
            if (filtered.length === 0) { container.innerHTML = `<p class="text-center text-slate-500 text-sm mt-10 p-6">No contacts found.</p>`; return; }
            filtered.forEach(user => {
                const isActive = activeContactMobile === user.mobile;
                const activeClass = isActive ? 'contact-active bg-white/5' : 'hover:bg-white/5 border-l-4 border-transparent';
                const latest = latestMessages[user.mobile];
                let preview = "Tap to start chatting", time = "", isUnread = false, previewClass = "text-slate-400";
                if (latest) {
                    const isMe = latest.senderMobile === myMobile;
                    let tick = latest.read ? "text-cyan-400" : "text-slate-500";
                    const prefix = isMe ? `<i class='fa-solid fa-check-double text-[11px] mr-1 ${tick}'></i> ` : "";
                    if (latest.text) preview = prefix + escapeHTML(latest.text);
                    else if (latest.fileUrl) preview = prefix + (latest.fileType?.startsWith('image/') ? "üì∑ Photo" : "üìÅ File");
                    time = latest.timeString || "";
                    if (!isMe && !latest.read) { isUnread = true; previewClass = "text-white font-semibold"; }
                }
                const avatar = getAvatarUrl(user.name, user.avatarUrl);
                const isOnline = (Date.now() - user.lastActive) < 120000;
                const dot = isOnline ? 'bg-emerald-500' : 'bg-slate-700';
                const div = document.createElement('div');
                div.className = `flex items-center cursor-pointer transition-colors p-3 border-b border-white/5 ${activeClass}`;
                div.onclick = () => openPrivateChat(user.name, user.mobile, avatar);
                div.innerHTML = `<div class="relative shrink-0 mr-4"><img src="${avatar}" class="w-12 h-12 rounded-[1rem] object-cover bg-slate-800 border border-white/10 shadow-sm"><span class="absolute -bottom-1 -right-1 w-3.5 h-3.5 ${dot} border-2 border-[#0f172a] rounded-full"></span></div><div class="flex-grow flex flex-col justify-center overflow-hidden"><div class="flex justify-between items-center mb-0.5"><h3 class="text-[15px] font-bold text-white truncate pr-2">${user.name}</h3><span class="text-[10px] ${isUnread ? 'text-pink-400 font-bold' : 'text-slate-500'} shrink-0">${time}</span></div><div class="flex justify-between items-center gap-2"><p class="text-xs ${previewClass} truncate w-full">${preview}</p>${isUnread ? '<span class="bg-pink-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full ml-2">New</span>' : ''}</div></div>`;
                container.appendChild(div);
            });
        }
        function openPrivateChat(name, mobile, avatar) {
            activeContactMobile = mobile; localStorage.setItem(`read_${mobile}`, Date.now());
            document.getElementById('active-chat-name').innerText = name;
            document.getElementById('active-chat-avatar').src = avatar;
            document.getElementById('empty-chat-state').classList.add('hidden');
            if (window.innerWidth < 768) { history.pushState({ chatOpen: true }, "Chat", "#chat"); document.getElementById('sidebar').classList.add('hidden'); document.getElementById('chat-area').classList.remove('hidden'); document.getElementById('chat-area').classList.add('flex'); }
            else { document.getElementById('chat-area').classList.remove('hidden'); document.getElementById('chat-area').classList.add('flex'); }
            renderContacts();
            document.querySelectorAll('.pvt-msg').forEach(e => e.remove());
            const q = query(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, mobile)}`), orderBy('timestamp', 'asc'), limit(200));
            if (currentChatUnsubscribe) currentChatUnsubscribe();
            currentChatUnsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    if (!data.read && data.senderMobile !== myMobile) updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, mobile)}`, change.doc.id), { read: true });
                    if (change.type === "added") msgBox.appendChild(createMessageElement(change.doc.id, data));
                    else if (change.type === "modified") { const old = document.getElementById(`msg-${change.doc.id}`); if(old) old.replaceWith(createMessageElement(change.doc.id, data)); }
                    else if (change.type === "removed") { const m = document.getElementById(`msg-${change.doc.id}`); if(m) m.remove(); }
                });
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        // Additional handlers for UI
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');
        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-name-input').value = myName; document.getElementById('settings-avatar-preview').src = getAvatarUrl(myName, myAvatarUrl); };
        window.previewProfilePic = (e) => { const f = e.target.files[0]; if(f) { settingsSelectedFile = f; const r = new FileReader(); r.onload = (ev) => document.getElementById('settings-avatar-preview').src = ev.target.result; r.readAsDataURL(f); } };
        window.saveProfileSettings = async () => {
            const newName = document.getElementById('settings-name-input').value.trim();
            if(!newName) return;
            if(settingsSelectedFile) {
                const fd = new FormData(); fd.append('file', settingsSelectedFile); fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
                const data = await res.json(); if(data.secure_url) myAvatarUrl = data.secure_url;
            }
            await setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { name: newName, avatarUrl: myAvatarUrl }, { merge: true });
            myName = newName; localStorage.setItem('pvt_chat_name', newName); localStorage.setItem('pvt_chat_avatar', myAvatarUrl);
            document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl); document.getElementById('my-name-display').innerText = myName;
            closeSettings();
        };

        window.clearFile = () => { selectedFile = null; document.getElementById('file-preview-container').classList.add('hidden'); document.getElementById('send-btn').disabled = document.getElementById('msg-input').value.trim() === ''; };
        window.toggleMic = () => { if(localStream) { const t = localStream.getAudioTracks()[0]; t.enabled = !t.enabled; const b = document.getElementById('mic-toggle-btn'); b.innerHTML = t.enabled ? '<i class="fa-solid fa-microphone"></i>' : '<i class="fa-solid fa-microphone-slash"></i>'; b.classList.toggle('text-red-500', !t.enabled); } };
        window.toggleCamera = () => { if(localStream) { const t = localStream.getVideoTracks()[0]; t.enabled = !t.enabled; const b = document.getElementById('cam-toggle-btn'); b.innerHTML = t.enabled ? '<i class="fa-solid fa-video"></i>' : '<i class="fa-solid fa-video-slash"></i>'; b.classList.toggle('text-red-500', !t.enabled); } };

        function createMessageElement(docId, data) {
            const isMe = data.senderMobile === myMobile;
            const bubble = isMe ? 'bg-gradient-to-br from-pink-600 to-purple-600 self-end rounded-tr-sm shadow-md' : 'bg-slate-800 border border-white/5 self-start rounded-tl-sm shadow-md';
            const div = document.createElement('div');
            div.id = `msg-${docId}`;
            div.className = `pvt-msg flex flex-col max-w-[85%] md:max-w-[65%] ${bubble} p-3 rounded-2xl mb-2 relative cursor-pointer select-none group`;
            div.onclick = (e) => toggleReactionMenu(docId, e);
            let media = '';
            if (data.fileUrl) {
                if (data.fileType?.startsWith('image/')) media = `<img src="${data.fileUrl}" class="rounded-xl mb-1 max-h-64 w-full object-cover" onclick="openLightbox('${data.fileUrl}', event)">`;
                else media = `<a href="${data.fileUrl}" target="_blank" class="bg-black/20 p-2 rounded-lg flex items-center gap-2 text-xs mb-1 border border-white/5"><i class="fa-solid fa-file text-pink-400"></i><span class="truncate text-white font-bold">${data.fileName}</span></a>`;
            }
            const tick = data.read ? "text-cyan-400" : "text-white/50";
            div.innerHTML = `${media}${data.text ? `<p class="text-[15px] font-medium text-white">${escapeHTML(data.text)}</p>` : ''}<div class="flex items-center justify-end mt-1 opacity-60 text-[9px] font-bold text-white"><span>${data.timeString}</span>${isMe ? `<i class='fa-solid fa-check-double ${tick} ml-1'></i>` : ''}</div><div id="react-menu-${docId}" class="reaction-menu-popup hidden absolute ${isMe?'right-0':'left-0'} -top-12 bg-slate-900 border border-white/10 rounded-full flex gap-2 px-3 py-1 shadow-2xl z-[60]"><button onclick="addReaction('${docId}','üëç',event)">üëç</button><button onclick="addReaction('${docId}','‚ù§Ô∏è',event)">‚ù§Ô∏è</button><button onclick="deleteMsg('${docId}',event)" class="text-red-500 ml-1">üóëÔ∏è</button></div>`;
            return div;
        }

        function escapeHTML(s) { return s.replace(/[&<>'"]/g, t => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[t] || t)); }
    </script>
</body>
</html>
