<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111b21">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WhatsApp Web Clone | Web Tools Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap');
        
        /* ðŸ”¥ WhatsApp Dark Mode Variables & Fixes ðŸ”¥ */
        :root {
            --wa-bg: #111b21;
            --wa-panel: #202c33;
            --wa-sent: #005c4b;
            --wa-received: #202c33;
            --wa-text: #e9edef;
            --wa-muted: #8696a0;
            --wa-green: #00a884;
            --wa-blue-tick: #53bdeb;
            --wa-border: #222d34;
        }

        html, body { 
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: var(--wa-bg); 
            color: var(--wa-text); 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            margin: 0;
            padding: 0;
            position: fixed; 
            top: 0;
            left: 0;
            touch-action: none;
        }
        
        .chat-bg {
            background-color: #0b141a;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            background-size: contain;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .msg-bubble { animation: popIn 0.2s ease-out forwards; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #374045; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #51585c; }
        
        textarea, input { font-size: 16px !important; } 
        
        .contact-active { background-color: #2a3942; }

        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; animation: popIn 0.15s ease-out forwards; }

        /* ðŸ”¥ Custom Audio Player Styles ðŸ”¥ */
        .audio-slider {
            -webkit-appearance: none;
            background: #4a5d66;
            height: 4px;
            border-radius: 5px;
            outline: none;
        }
        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--wa-green);
            cursor: pointer;
        }
    </style>
</head>
<body class="flex selection:bg-[#00a884]/30">

    <!-- ðŸ”¥ Telegram Style Soft Pop Sound for Notification ðŸ”¥ -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="ringtone-sound" src="https://assets.mixkit.co/active_storage/sfx/2803/2803-preview.mp3" preload="auto" loop></audio>

    <div id="image-lightbox" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-sm transition-opacity opacity-0" onclick="closeLightbox()">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 md:top-8 md:right-8 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white text-xl hover:bg-gray-800 transition-colors z-50">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain p-2 md:p-8 transform scale-95 transition-transform duration-300 shadow-2xl">
    </div>

    <!-- Registration Modal -->
    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#111b21] transition-opacity">
        <div class="bg-[#202c33] p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center">
            <div class="w-16 h-16 bg-[#00a884] rounded-full flex items-center justify-center mb-6 mx-auto shadow-lg">
                <i class="fa-brands fa-whatsapp text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-semibold mb-2 text-[#e9edef]">WhatsApp Web</h2>
            <p class="text-[#8696a0] text-sm mb-8">Enter your details to connect</p>
            
            <form id="join-form" class="space-y-4">
                <input type="text" id="reg-name" required autocomplete="off" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-[#e9edef] text-center focus:outline-none focus:border-[#00a884] transition-all" placeholder="Your Name">
                <input type="tel" id="reg-mobile" required autocomplete="off" pattern="[0-9]{11}" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-[#e9edef] text-center focus:outline-none focus:border-[#00a884] transition-all tracking-widest" placeholder="Phone Number (11 digits)">
                
                <button type="submit" id="join-btn" class="w-full bg-[#00a884] hover:bg-[#029071] py-3 rounded-lg text-[#111b21] font-bold uppercase tracking-wider transition-all shadow-lg active:scale-95 mt-4">Connect</button>
            </form>
        </div>
    </div>

    <!-- PROFILE SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-[#202c33] p-8 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <button onclick="closeSettings()" class="absolute top-4 right-4 w-8 h-8 rounded-full text-[#8696a0] hover:bg-white/10 flex items-center justify-center transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 class="text-xl font-semibold mb-6 text-[#e9edef]">Profile Settings</h2>

            <div class="relative w-32 h-32 mx-auto mb-6 group cursor-pointer" onclick="document.getElementById('profile-pic-input').click()">
                <img id="settings-avatar-preview" src="" class="w-full h-full rounded-full object-cover group-hover:opacity-60 transition-opacity bg-[#111b21]">
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full bg-black/40">
                    <i class="fa-solid fa-camera text-3xl text-white"></i>
                </div>
            </div>
            <input type="file" id="profile-pic-input" accept="image/*" class="hidden" onchange="previewProfilePic(event)">

            <div class="mb-6 text-left">
                <label class="text-[#00a884] text-sm font-semibold mb-1 block">Your Name</label>
                <div class="flex items-center bg-[#111b21] rounded-lg border-b-2 border-[#00a884] px-2 py-1">
                    <input type="text" id="settings-name-input" class="w-full bg-transparent p-2 text-[#e9edef] focus:outline-none text-lg" placeholder="Enter your name">
                    <i class="fa-solid fa-pen text-[#8696a0] text-sm pr-2"></i>
                </div>
                <p class="text-[#8696a0] text-xs mt-2">This is not your username or pin. This name will be visible to your contacts.</p>
            </div>

            <button id="save-settings-btn" onclick="saveProfileSettings()" class="w-full bg-[#00a884] hover:bg-[#029071] py-3 rounded-lg text-[#111b21] font-bold uppercase tracking-wider transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-check"></i> Save Details
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden absolute top-0 left-0 w-full max-w-[1600px] mx-auto md:py-5 md:px-5" style="height: 100%;">
        <div class="w-full h-full flex bg-[#111b21] shadow-2xl md:rounded-lg overflow-hidden relative">
            
            <!-- LEFT SIDEBAR (Contacts) -->
            <div id="sidebar" class="w-full md:w-[400px] flex flex-col border-r border-[#222d34] z-20 flex-shrink-0 bg-[#111b21] absolute md:relative inset-0 md:inset-auto">
                <!-- Top Header -->
                <header class="p-3 bg-[#202c33] flex items-center justify-between shrink-0" style="padding-top: max(0.75rem, env(safe-area-inset-top));">
                    <div class="flex items-center gap-3">
                        <img id="my-avatar" src="" onclick="openSettings()" class="w-10 h-10 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity" title="Profile Settings">
                    </div>
                    <div class="flex items-center gap-4 text-[#aebac1] text-xl">
                        <i class="fa-solid fa-users cursor-pointer hover:text-[#e9edef] hidden md:block"></i>
                        <i class="fa-solid fa-circle-notch cursor-pointer hover:text-[#e9edef] hidden md:block"></i>
                        <i class="fa-solid fa-message cursor-pointer hover:text-[#e9edef]"></i>
                        
                        <div class="relative">
                            <button onclick="toggleSidebarMenu(event)" class="focus:outline-none hover:text-[#e9edef]"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="sidebar-dropdown" class="dropdown-menu absolute top-10 right-0 bg-[#233138] rounded shadow-2xl py-2 w-40 z-50 text-[#e9edef] text-sm">
                                <button onclick="openSettings()" class="w-full text-left px-5 py-3 hover:bg-[#111b21] transition-colors">Settings</button>
                                <button onclick="logoutPvtChat()" class="w-full text-left px-5 py-3 hover:bg-[#111b21] transition-colors text-red-400">Log out</button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Search Bar -->
                <div class="p-2 bg-[#111b21] border-b border-[#222d34] shrink-0">
                    <div class="bg-[#202c33] rounded-lg flex items-center px-3 py-1.5 transition-colors">
                        <button class="text-[#8696a0] hover:text-[#00a884]"><i class="fa-solid fa-arrow-left text-sm hidden"></i><i class="fa-solid fa-magnifying-glass text-sm" id="search-icon"></i></button>
                        <input type="text" id="search-input" placeholder="Search or start new chat" class="bg-transparent border-none outline-none text-[#e9edef] text-sm w-full ml-4 placeholder-[#8696a0]">
                    </div>
                </div>

                <!-- Contacts List -->
                <div id="contacts-list" class="flex-grow overflow-y-auto custom-scroll relative bg-[#111b21]" style="touch-action: pan-y;">
                    <div id="contacts-container" class="pb-6"></div>
                </div>
            </div>

            <!-- RIGHT SIDEBAR (Chat Window) -->
            <div id="chat-area" class="w-full hidden flex-col relative h-full bg-[#222eb]">
                
                <div id="empty-chat-state" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-[#222eb] border-l border-[#222d34]">
                    <div class="text-center">
                        <img src="https://static.whatsapp.net/rsrc.php/v3/y6/r/wa669aeJeom.png" alt="WhatsApp Web" class="w-80 mb-6 mx-auto opacity-80">
                        <h2 class="text-3xl font-light text-[#e9edef] mb-4">WhatsApp Web</h2>
                        <p class="text-[#8696a0] text-sm mb-8 max-w-md mx-auto leading-relaxed">Send and receive messages without keeping your phone online.<br>Use WhatsApp on up to 4 linked devices and 1 phone at the same time.</p>
                        <p class="text-[#8696a0] text-xs flex items-center justify-center gap-2"><i class="fa-solid fa-lock text-[10px]"></i> End-to-end encrypted</p>
                    </div>
                </div>

                <!-- Chat Header -->
                <header class="p-2.5 md:p-3 bg-[#202c33] flex items-center justify-between shrink-0 relative z-30" style="padding-top: max(0.5rem, env(safe-area-inset-top)); border-left: 1px solid #222d34;">
                    <div class="flex items-center gap-3">
                        <button onclick="closeChatMobile()" class="md:hidden w-10 h-10 flex items-center justify-center rounded-full text-[#aebac1] hover:bg-white/10 shrink-0 transition-colors -ml-2">
                            <i class="fa-solid fa-arrow-left text-xl"></i>
                        </button>
                        <div class="flex items-center gap-3 cursor-pointer">
                            <img id="active-chat-avatar" src="" class="w-10 h-10 rounded-full object-cover">
                            <div class="flex flex-col justify-center">
                                <h2 id="active-chat-name" class="text-base text-[#e9edef] leading-tight">Contact</h2>
                                <p id="active-chat-status" class="text-[13px] text-[#8696a0] leading-tight">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 text-[#aebac1] text-xl items-center pr-2 relative">
                        <button onclick="startCall('video')" class="hover:text-[#e9edef] transition-colors"><i class="fa-solid fa-video"></i></button>
                        <button onclick="startCall('audio')" class="hover:text-[#e9edef] transition-colors"><i class="fa-solid fa-phone"></i></button>
                        <div class="w-[1px] h-6 bg-[#8696a0] opacity-30 hidden md:block"></div>
                        <button class="hover:text-[#e9edef] transition-colors hidden md:block"><i class="fa-solid fa-magnifying-glass"></i></button>
                        
                        <div class="relative">
                            <button onclick="toggleChatMenu(event)" class="hover:text-[#e9edef] transition-colors"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="chat-dropdown" class="dropdown-menu absolute top-10 right-0 bg-[#233138] rounded shadow-2xl py-2 w-48 z-50 text-[#e9edef] text-sm">
                                <button class="w-full text-left px-5 py-3 hover:bg-[#111b21] transition-colors">Contact info</button>
                                <button onclick="clearEntireChat()" class="w-full text-left px-5 py-3 hover:bg-[#111b21] transition-colors text-red-400">Clear messages</button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Chat Messages Area -->
                <main id="messages-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-8 flex flex-col gap-1 custom-scroll relative z-20" onclick="closeAllMenus()" style="touch-action: pan-y;">
                    <div class="text-center my-4">
                        <span class="bg-[#182229] text-[#ffd279] text-xs px-4 py-2 rounded-lg shadow-sm inline-flex items-center gap-2 max-w-sm text-center leading-relaxed font-medium">
                            <i class="fa-solid fa-lock text-[#ffd279]"></i> 
                            Messages and calls are end-to-end encrypted. No one outside of this chat, not even WhatsApp, can read or listen to them.
                        </span>
                    </div>
                </main>

                <!-- Chat Input Footer -->
                <footer class="p-3 bg-[#202c33] shrink-0 relative z-30" style="padding-bottom: max(0.75rem, env(safe-area-inset-bottom));">
                    
                    <div id="file-preview-container" class="hidden w-full px-2 mb-3">
                        <div class="bg-[#111b21] rounded-lg p-3 flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div id="preview-icon-wrapper" class="w-12 h-12 rounded bg-[#202c33] text-[#aebac1] flex items-center justify-center shrink-0 overflow-hidden relative">
                                    <i id="preview-icon" class="fa-solid fa-file text-2xl"></i>
                                    <img id="preview-img" src="" class="hidden w-full h-full object-cover absolute inset-0">
                                </div>
                                <div class="overflow-hidden">
                                    <p id="file-preview-name" class="text-sm text-[#e9edef] truncate w-48 md:w-72">filename</p>
                                    <p id="file-preview-size" class="text-xs text-[#8696a0] mt-0.5">0 MB</p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFile()" class="text-[#8696a0] hover:text-red-400 w-10 h-10 flex items-center justify-center rounded-full transition-colors">
                                <i class="fa-solid fa-xmark text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Recording UI -->
                    <div id="recording-ui" class="hidden flex items-center justify-between bg-[#111b21] rounded-lg p-2 animate-pulse mb-2">
                        <div class="flex items-center gap-3 text-red-500 pl-4 text-sm font-medium">
                            <i class="fa-solid fa-microphone animate-bounce"></i> <span>Recording audio...</span>
                        </div>
                        <div class="flex gap-2 pr-2 text-[#aebac1]">
                            <button type="button" onclick="cancelRecording()" class="w-10 h-10 hover:bg-[#202c33] rounded-full flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button type="button" onclick="stopAndSendRecording()" class="w-10 h-10 hover:bg-[#202c33] text-[#00a884] rounded-full flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-paper-plane text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <form id="chat-form" class="flex items-end gap-2 w-full relative">
                        <div class="flex gap-1 text-[#aebac1] text-2xl pb-2 items-center">
                            <button type="button" class="w-10 h-10 hover:bg-white/5 rounded-full flex items-center justify-center transition-colors"><i class="fa-regular fa-face-smile"></i></button>
                            <button type="button" onclick="document.getElementById('file-input').click()" class="w-10 h-10 hover:bg-white/5 rounded-full flex items-center justify-center transition-colors transform -rotate-45"><i class="fa-solid fa-paperclip text-[22px]"></i></button>
                        </div>
                        <input type="file" id="file-input" class="hidden">

                        <div class="flex-grow bg-[#2a3942] rounded-lg flex items-center px-3 py-1 my-1">
                            <textarea id="msg-input" rows="1" placeholder="Type a message"
                                class="w-full bg-transparent p-2 text-[#e9edef] focus:outline-none resize-none max-h-32 custom-scroll text-[15px] placeholder-[#8696a0]" style="min-height: 40px;"></textarea>
                        </div>
                        
                        <div class="pb-1.5 flex items-center justify-center w-12 h-12">
                            <button type="button" id="mic-btn" onclick="startRecording()" class="w-10 h-10 text-[#aebac1] hover:text-[#e9edef] flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-microphone text-2xl"></i>
                            </button>
                            
                            <button type="submit" id="send-btn" class="hidden w-10 h-10 text-[#aebac1] hover:text-[#e9edef] flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-paper-plane text-2xl"></i>
                            </button>
                        </div>
                    </form>
                </footer>
            </div>
        </div>
    </div>

    <!-- ðŸ”¥ AUDIO & VIDEO CALL UI MODAL ðŸ”¥ -->
    <div id="call-modal" class="hidden fixed inset-0 z-[300] bg-[#111b21] overflow-hidden flex-col">
        <audio id="remote-audio" autoplay playsinline></audio>
        <video id="remote-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover hidden z-0"></video>
        <video id="local-video" autoplay playsinline muted class="absolute top-12 right-4 md:top-8 md:right-8 w-28 h-40 md:w-40 md:h-56 bg-black rounded-xl border border-[#222d34] object-cover hidden z-20 shadow-2xl"></video>

        <div id="call-overlay" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-[#111b21] transition-opacity duration-500">
            <div class="relative mb-6">
                <img id="call-avatar" src="" class="w-32 h-32 rounded-full object-cover z-10 relative">
                <div class="absolute inset-0 border-4 border-[#00a884] rounded-full animate-ping opacity-50 z-0"></div>
            </div>
            <h2 id="call-name" class="text-2xl text-[#e9edef] mb-2 font-normal">Caller Name</h2>
            <p id="call-status" class="text-[#8696a0] text-sm tracking-wide">Calling...</p>
        </div>
        
        <!-- Call Controls -->
        <div class="absolute bottom-10 md:bottom-12 left-1/2 -translate-x-1/2 flex items-center justify-center gap-6 z-30 w-full px-4">
            <button id="answer-btn" onclick="answerCall()" class="hidden w-14 h-14 rounded-full bg-[#00a884] text-white text-xl hover:bg-[#029071] transition-colors shadow-lg flex items-center justify-center">
                <i class="fa-solid fa-phone"></i>
            </button>

            <!-- In Call Controls -->
            <div id="in-call-controls" class="hidden flex items-center gap-4 bg-[#202c33] p-2 rounded-full border border-[#222d34] shadow-2xl">
                <button id="mic-toggle-btn" onclick="toggleMic()" class="w-12 h-12 rounded-full bg-[#374045] text-[#e9edef] text-lg hover:bg-[#4a5d66] transition-colors">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <button id="cam-toggle-btn" onclick="toggleCamera()" class="w-12 h-12 rounded-full bg-[#374045] text-[#e9edef] text-lg hover:bg-[#4a5d66] transition-colors hidden">
                    <i class="fa-solid fa-video"></i>
                </button>
                
                <button id="hangup-btn" onclick="hangupCall()" class="w-12 h-12 rounded-full bg-[#f15c6d] text-white text-xl hover:bg-[#d85361] transition-colors shadow-lg flex items-center justify-center ml-2">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
            
            <button id="caller-hangup-btn" onclick="hangupCall()" class="hidden w-14 h-14 rounded-full bg-[#f15c6d] text-white text-xl hover:bg-[#d85361] transition-colors shadow-lg flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

    <!-- Firebase & Chat Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Viewport Fix
        function setRealViewportHeight() {
            let vh = window.innerHeight;
            if (window.visualViewport) vh = window.visualViewport.height;
            document.body.style.height = vh + 'px';
            document.documentElement.style.height = vh + 'px';
            
            const appContainer = document.getElementById('app-container');
            if (appContainer) appContainer.style.height = vh + 'px';
            const msgBox = document.getElementById('messages-box');
            if(msgBox) setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 50);
        }
        window.addEventListener('resize', setRealViewportHeight);
        if (window.visualViewport) window.visualViewport.addEventListener('resize', setRealViewportHeight);
        setRealViewportHeight();

        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };
        
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/de2w78yxh/auto/upload"; 
        const CLOUDINARY_UPLOAD_PRESET = "ml_default"; 
        const SYNC_APP_ID = "rasel-mia-universal-sync";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myName = localStorage.getItem('pvt_chat_name') || '';
        let myMobile = localStorage.getItem('pvt_chat_mobile') || '';
        let myAvatarUrl = localStorage.getItem('pvt_chat_avatar') || ''; 
        
        let activeContactMobile = null;
        let allUsers = [];
        let latestMessages = {}; 
        let chatListeners = {};  

        let currentChatUnsubscribe = null;
        let userStatusUnsubscribe = null;
        let activeTrackingInterval = null;
        let selectedFile = null;
        let typingTimeout = null; 

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let settingsSelectedFile = null;
        
        // WebRTC Variables
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }] };
        let pc = null;
        let localStream = null;
        let incomingCallData = null;
        let currentCallId = null; 
        let remoteDescriptionSet = false;
        let iceCandidateQueue = [];

        const appStartTime = Date.now();

        const joinModal = document.getElementById('join-modal');
        const appContainer = document.getElementById('app-container');
        const contactsContainer = document.getElementById('contacts-container');
        const searchInput = document.getElementById('search-input');
        const emptyState = document.getElementById('empty-chat-state');
        
        const chatArea = document.getElementById('chat-area');
        const sidebar = document.getElementById('sidebar');
        const msgBox = document.getElementById('messages-box');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const fileInput = document.getElementById('file-input');
        const previewIcon = document.getElementById('preview-icon');
        const previewImg = document.getElementById('preview-img');

        function getAvatarUrl(name, customUrl) {
            return customUrl ? customUrl : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=202c33&color=e9edef`;
        }
        function formatTime(seconds) {
            if(!seconds || isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        // ðŸ”¥ Ask for notification permission on start ðŸ”¥
        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        if (myName && myMobile) startApp(); else joinModal.classList.remove('hidden');

        // Lightbox
        window.openLightbox = (url, e) => {
            e.stopPropagation();
            const lightbox = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = url;
            lightbox.classList.remove('hidden');
            setTimeout(() => { lightbox.classList.remove('opacity-0'); img.classList.remove('scale-95'); img.classList.add('scale-100'); }, 10);
        };
        window.closeLightbox = () => {
            const lightbox = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            lightbox.classList.add('opacity-0'); img.classList.remove('scale-100'); img.classList.add('scale-95');
            setTimeout(() => lightbox.classList.add('hidden'), 300);
        };

        // Menus & Modals
        window.toggleSidebarMenu = (e) => { e.stopPropagation(); document.getElementById('sidebar-dropdown').classList.toggle('show'); }
        window.toggleChatMenu = (e) => { e.stopPropagation(); document.getElementById('chat-dropdown').classList.toggle('show'); }
        window.closeAllMenus = () => {
            document.getElementById('sidebar-dropdown').classList.remove('show');
            document.getElementById('chat-dropdown').classList.remove('show');
            document.querySelectorAll('.reaction-menu-popup').forEach(el => el.classList.add('hidden'));
        }
        document.body.addEventListener('click', closeAllMenus);

        window.logoutPvtChat = () => {
            if(confirm("Log out from WhatsApp Web?")) {
                localStorage.clear();
                location.reload();
            }
        };

        window.openSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-avatar-preview').src = getAvatarUrl(myName, myAvatarUrl);
            document.getElementById('settings-name-input').value = myName;
            settingsSelectedFile = null;
        }

        window.closeSettings = () => {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('profile-pic-input').value = '';
        }

        window.previewProfilePic = (event) => {
            const file = event.target.files[0];
            if(file && file.type.startsWith('image/')) {
                if(file.size > 5 * 1024 * 1024) { alert("Max size 5MB allowed for profile picture"); return; }
                settingsSelectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('settings-avatar-preview').src = e.target.result;
                reader.readAsDataURL(file);
            }
        }

        window.saveProfileSettings = async () => {
            const newName = document.getElementById('settings-name-input').value.trim();
            if(!newName) { alert("Name cannot be empty"); return; }

            const saveBtn = document.getElementById('save-settings-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                let updatedAvatarUrl = myAvatarUrl;

                if(settingsSelectedFile) {
                    const formData = new FormData();
                    formData.append('file', settingsSelectedFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const uploadResult = await response.json();
                    if(uploadResult.secure_url) updatedAvatarUrl = uploadResult.secure_url;
                    else throw new Error("Cloudinary failed");
                }

                await setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), {
                    name: newName, avatarUrl: updatedAvatarUrl
                }, { merge: true });

                myName = newName;
                myAvatarUrl = updatedAvatarUrl;
                localStorage.setItem('pvt_chat_name', newName);
                localStorage.setItem('pvt_chat_avatar', updatedAvatarUrl);
                document.getElementById('my-avatar').src = getAvatarUrl(newName, updatedAvatarUrl);
                
                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                setTimeout(() => {
                    closeSettings();
                    saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Save Details';
                    saveBtn.disabled = false;
                }, 1000);
            } catch(e) {
                alert("Upload failed. Check connection.");
                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Save Details';
                saveBtn.disabled = false;
            }
        }

        window.clearEntireChat = async () => {
            closeAllMenus();
            if(confirm("Clear this chat?")) {
                try {
                    const chatId = generateChatId(myMobile, activeContactMobile);
                    const msgRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`);
                    const q = query(msgRef, limit(100)); 
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((document) => { deleteDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`, document.id)); });
                    document.querySelectorAll('.pvt-msg').forEach(e => e.remove());
                } catch(e) {}
            }
        }

        document.getElementById('join-form').onsubmit = async (e) => {
            e.preventDefault();
            const n = document.getElementById('reg-name').value.trim();
            const m = document.getElementById('reg-mobile').value.trim();
            const joinBtn = document.getElementById('join-btn');

            if (n && m.length === 11) {
                const originalText = joinBtn.innerHTML;
                joinBtn.disabled = true;
                joinBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connecting...';

                try {
                    await signInAnonymously(auth);
                    const userRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', m);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        const existingName = userSnap.data().name;
                        if (existingName.toLowerCase() !== n.toLowerCase()) {
                            alert(`This number is registered to "${existingName}". Please use your correct name.`);
                            joinBtn.disabled = false; joinBtn.innerHTML = originalText;
                            return; 
                        }
                        if(userSnap.data().avatarUrl) {
                            myAvatarUrl = userSnap.data().avatarUrl;
                            localStorage.setItem('pvt_chat_avatar', myAvatarUrl);
                        }
                    } else {
                        await setDoc(userRef, { name: n, mobile: m, lastActive: Date.now(), typingTo: null, avatarUrl: '' });
                    }

                    myName = n; myMobile = m;
                    localStorage.setItem('pvt_chat_name', n); localStorage.setItem('pvt_chat_mobile', m);
                    
                    if ("Notification" in window && Notification.permission !== "granted") {
                        Notification.requestPermission();
                    }

                    joinModal.classList.add('hidden'); startApp();

                } catch (err) {
                    alert("Connection error!");
                    joinBtn.disabled = false; joinBtn.innerHTML = originalText;
                }
            } else { alert("Please provide valid details."); }
        };

        function toggleInputButtons() {
            const hasText = msgInput.value.trim().length > 0;
            const hasFile = !!selectedFile;
            
            if (hasText || hasFile) {
                micBtn.classList.add('hidden'); sendBtn.classList.remove('hidden'); sendBtn.disabled = false;
            } else {
                micBtn.classList.remove('hidden'); sendBtn.classList.add('hidden');
            }
        }

        msgInput.addEventListener('focus', () => { setTimeout(() => setRealViewportHeight(), 150); });
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight < 100 ? this.scrollHeight : 100) + 'px';
            toggleInputButtons();

            if (activeContactMobile) {
                setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { typingTo: activeContactMobile }, { merge: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { typingTo: null }, { merge: true });
                }, 2000);
            }
        });

        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if(!sendBtn.disabled) chatForm.dispatchEvent(new Event('submit')); }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 30 * 1024 * 1024) { alert("File size limit is 30MB!"); fileInput.value = ''; return; }
                selectedFile = file;
                document.getElementById('file-preview-name').innerText = file.name;
                document.getElementById('file-preview-size').innerText = (file.size / 1024 / 1024).toFixed(2) + " MB";
                
                previewIcon.className = "hidden"; previewImg.classList.add("hidden");
                if(file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => { previewImg.src = e.target.result; previewImg.classList.remove('hidden'); };
                    reader.readAsDataURL(file);
                } else {
                    previewIcon.className = "fa-solid text-2xl";
                    if(file.type.startsWith('video/')) previewIcon.classList.add("fa-video", "text-pink-400");
                    else if(file.type.startsWith('audio/')) previewIcon.classList.add("fa-headphones", "text-emerald-400");
                    else previewIcon.classList.add("fa-file", "text-slate-300");
                }
                document.getElementById('file-preview-container').classList.remove('hidden');
                toggleInputButtons();
            }
        });

        window.clearFile = () => {
            selectedFile = null; fileInput.value = '';
            document.getElementById('file-preview-container').classList.add('hidden');
            previewImg.src = ''; toggleInputButtons();
        };

        window.startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => { audioChunks.push(event.data); });
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recording-ui').classList.remove('hidden');
                msgInput.parentElement.classList.add('hidden');
                micBtn.parentElement.classList.add('hidden'); // hide mic wrapper
            } catch (err) { alert("Microphone permission denied."); }
        }

        window.cancelRecording = () => {
            if(mediaRecorder && isRecording) { mediaRecorder.stop(); }
            isRecording = false; audioChunks = [];
            document.getElementById('recording-ui').classList.add('hidden');
            msgInput.parentElement.classList.remove('hidden');
            micBtn.parentElement.classList.remove('hidden');
            toggleInputButtons();
        }

        window.stopAndSendRecording = () => {
            if(mediaRecorder && isRecording) {
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' }); 
                    const audioFile = new File([audioBlob], `VoiceNote_${Date.now()}.mp3`, { type: 'audio/mp3' });
                    selectedFile = audioFile; 
                    chatForm.dispatchEvent(new Event('submit')); 
                });
                mediaRecorder.stop();
            }
            isRecording = false;
            document.getElementById('recording-ui').classList.add('hidden');
            msgInput.parentElement.classList.remove('hidden');
            micBtn.parentElement.classList.remove('hidden');
        }

        function generateChatId(mob1, mob2) { return mob1 < mob2 ? `${mob1}_${mob2}` : `${mob2}_${mob1}`; }

        async function startApp() {
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            
            document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl);

            try {
                await signInAnonymously(auth);
                const myRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile);
                const mySnap = await getDoc(myRef);
                if(mySnap.exists()) {
                    const d = mySnap.data();
                    if(d.avatarUrl) {
                        myAvatarUrl = d.avatarUrl;
                        localStorage.setItem('pvt_chat_avatar', myAvatarUrl);
                        document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl);
                    }
                    if(d.name && d.name !== myName) {
                        myName = d.name; localStorage.setItem('pvt_chat_name', myName);
                    }
                }

                const updateMyStatus = async () => {
                    await setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), {
                        name: myName, mobile: myMobile, lastActive: Date.now()
                    }, { merge: true });
                };
                updateMyStatus();
                activeTrackingInterval = setInterval(updateMyStatus, 60000);
                listenForUsers();
                listenForIncomingCalls(); 
            } catch (err) {}
        }

        // WebRTC
        function initializePeerConnection() {
            if (pc) pc.close();
            pc = new RTCPeerConnection(servers);
            remoteDescriptionSet = false; iceCandidateQueue = [];

            const remoteVideo = document.getElementById('remote-video');
            const remoteAudio = document.getElementById('remote-audio');
            remoteVideo.srcObject = new MediaStream();
            remoteAudio.srcObject = new MediaStream();

            pc.ontrack = event => {
                const track = event.track;
                if (track.kind === 'video') {
                    remoteVideo.srcObject.addTrack(track);
                    remoteVideo.classList.remove('hidden');
                    remoteVideo.play().catch(e=>{});
                } else if (track.kind === 'audio') {
                    remoteAudio.srcObject.addTrack(track);
                    remoteAudio.play().catch(e=>{});
                }
            };
            return pc;
        }

        async function processIceCandidate(candidateData) {
            if (remoteDescriptionSet) {
                await pc.addIceCandidate(new RTCIceCandidate(candidateData)).catch(e=>{});
            } else { iceCandidateQueue.push(candidateData); }
        }

        // ðŸ”¥ Notification Dispatcher Helper ðŸ”¥
        function sendBackgroundNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted" && document.hidden) {
                const notif = new Notification(title, {
                    body: body,
                    icon: "developer.jpg",
                    requireInteraction: true,
                    vibrate: [200, 100, 200, 100, 200]
                });
                notif.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }

        function listenForIncomingCalls() {
            const callsRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls');
            onSnapshot(callsRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const callData = change.doc.data();
                    const callId = change.doc.id;
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (callData.callee === myMobile && callData.status === 'calling') {
                            incomingCallData = { id: callId, ...callData };
                            
                            document.getElementById('call-modal').classList.remove('hidden');
                            document.getElementById('call-modal').classList.add('flex');
                            document.getElementById('call-name').innerText = "Incoming Call";
                            
                            // Find caller avatar
                            const caller = allUsers.find(u => u.mobile === callData.caller);
                            const callerName = caller ? caller.name : "Contact";
                            document.getElementById('call-avatar').src = caller ? getAvatarUrl(caller.name, caller.avatarUrl) : getAvatarUrl("User", "");
                            
                            const callTypeStr = callData.type === 'video' ? "WhatsApp Video Call" : "WhatsApp Voice Call";
                            document.getElementById('call-status').innerText = callTypeStr;
                            
                            document.getElementById('answer-btn').classList.remove('hidden');
                            document.getElementById('in-call-controls').classList.add('hidden');
                            document.getElementById('caller-hangup-btn').classList.add('hidden');
                            
                            if(callData.type === 'video') document.getElementById('answer-btn').innerHTML = '<i class="fa-solid fa-video"></i>';
                            else document.getElementById('answer-btn').innerHTML = '<i class="fa-solid fa-phone"></i>';
                            try { document.getElementById('ringtone-sound').play(); } catch(e){}

                            // ðŸ”¥ Trigger Background Call Notification
                            sendBackgroundNotification(`Incoming Call from ${callerName}`, callTypeStr);
                        }
                        if (callData.status === 'ended' && (currentCallId === callId || (incomingCallData && incomingCallData.id === callId))) {
                            resetCallUI();
                        }
                    }
                });
            });
        }

        window.startCall = async (type) => {
            if(!activeContactMobile) return;
            document.getElementById('call-modal').classList.remove('hidden');
            document.getElementById('call-modal').classList.add('flex');
            document.getElementById('call-name').innerText = document.getElementById('active-chat-name').innerText;
            document.getElementById('call-avatar').src = document.getElementById('active-chat-avatar').src;
            document.getElementById('call-status').innerText = "Calling...";
            
            document.getElementById('answer-btn').classList.add('hidden');
            document.getElementById('in-call-controls').classList.add('hidden');
            document.getElementById('caller-hangup-btn').classList.remove('hidden');
            document.getElementById('call-overlay').classList.remove('opacity-0', 'pointer-events-none');

            try {
                const constraints = { audio: true, video: type === 'video' ? { facingMode: "user" } : false };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                if(type === 'video') {
                    const localVid = document.getElementById('local-video');
                    localVid.srcObject = localStream; localVid.classList.remove('hidden');
                }
                pc = initializePeerConnection();
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                currentCallId = "call_" + generateChatId(myMobile, activeContactMobile) + "_" + Date.now();
                const callDocRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', currentCallId);
                const offerCandidates = collection(callDocRef, 'offerCandidates');
                const answerCandidates = collection(callDocRef, 'answerCandidates');

                pc.onicecandidate = event => { if(event.candidate) addDoc(offerCandidates, event.candidate.toJSON()); };

                const offerDescription = await pc.createOffer();
                await pc.setLocalDescription(offerDescription);

                await setDoc(callDocRef, {
                    offer: { type: offerDescription.type, sdp: offerDescription.sdp },
                    caller: myMobile, callee: activeContactMobile, type: type, status: 'calling', timestamp: Date.now()
                });

                const callUnsubscribe = onSnapshot(callDocRef, async (snapshot) => {
                    const data = snapshot.data();
                    if(pc && !remoteDescriptionSet && data?.answer) {
                        const answerDescription = new RTCSessionDescription(data.answer);
                        await pc.setRemoteDescription(answerDescription);
                        remoteDescriptionSet = true;
                        document.getElementById('call-status').innerText = "0:00";
                        document.getElementById('caller-hangup-btn').classList.add('hidden');
                        document.getElementById('in-call-controls').classList.remove('hidden');
                        
                        if(type === 'video') {
                            document.getElementById('call-overlay').classList.add('opacity-0', 'pointer-events-none');
                            document.getElementById('cam-toggle-btn').classList.remove('hidden');
                        }
                        for(let cand of iceCandidateQueue) await pc.addIceCandidate(new RTCIceCandidate(cand));
                        iceCandidateQueue = [];
                        onSnapshot(answerCandidates, (candSnapshot) => {
                            candSnapshot.docChanges().forEach(change => {
                                if(change.type === 'added') processIceCandidate(change.doc.data());
                            });
                        });
                    }
                });
                pc.callUnsubscribe = callUnsubscribe;
            } catch (err) { alert("Mic/Camera error"); resetCallUI(); }
        };

        window.answerCall = async () => {
            if(!incomingCallData) return;
            document.getElementById('ringtone-sound').pause(); document.getElementById('ringtone-sound').currentTime = 0;
            document.getElementById('call-status').innerText = "Connecting...";
            document.getElementById('answer-btn').classList.add('hidden');
            const type = incomingCallData.type;

            try {
                const constraints = { audio: true, video: type === 'video' ? { facingMode: "user" } : false };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                if(type === 'video') {
                    const localVid = document.getElementById('local-video');
                    localVid.srcObject = localStream; localVid.classList.remove('hidden');
                }
                pc = initializePeerConnection();
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                currentCallId = incomingCallData.id;
                const callDocRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', currentCallId);
                const answerCandidates = collection(callDocRef, 'answerCandidates');
                const offerCandidates = collection(callDocRef, 'offerCandidates');

                pc.onicecandidate = event => { if(event.candidate) addDoc(answerCandidates, event.candidate.toJSON()); };

                const offerDescription = new RTCSessionDescription(incomingCallData.offer);
                await pc.setRemoteDescription(offerDescription);
                remoteDescriptionSet = true;

                const answerDescription = await pc.createAnswer();
                await pc.setLocalDescription(answerDescription);

                await updateDoc(callDocRef, { answer: { type: answerDescription.type, sdp: answerDescription.sdp }, status: 'answered' });
                
                document.getElementById('call-status').innerText = "0:00";
                document.getElementById('in-call-controls').classList.remove('hidden');
                
                if(type === 'video') {
                    document.getElementById('call-overlay').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('cam-toggle-btn').classList.remove('hidden');
                }
                onSnapshot(offerCandidates, (snapshot) => {
                    snapshot.docChanges().forEach(change => { if(change.type === 'added') processIceCandidate(change.doc.data()); });
                });
            } catch(e) { alert("Connection failed."); resetCallUI(); }
        };

        window.hangupCall = async () => {
            const idToHangup = currentCallId || (incomingCallData ? incomingCallData.id : null);
            if(idToHangup) {
                const callDocRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'calls', idToHangup);
                await updateDoc(callDocRef, { status: 'ended' }).catch(()=>{});
            }
            resetCallUI();
        };

        function resetCallUI() {
            document.getElementById('ringtone-sound').pause(); document.getElementById('ringtone-sound').currentTime = 0;
            document.getElementById('call-modal').classList.remove('flex'); document.getElementById('call-modal').classList.add('hidden');
            document.getElementById('call-overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('local-video').classList.add('hidden'); document.getElementById('remote-video').classList.add('hidden');
            document.getElementById('cam-toggle-btn').classList.add('hidden');

            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            if (pc) { if(pc.callUnsubscribe) pc.callUnsubscribe(); pc.close(); pc = null; }
            incomingCallData = null; currentCallId = null; remoteDescriptionSet = false; iceCandidateQueue = [];
            const remoteVideo = document.getElementById('remote-video'); if(remoteVideo) { remoteVideo.srcObject = null; }
            const remoteAudio = document.getElementById('remote-audio'); if(remoteAudio) { remoteAudio.srcObject = null; }
            const localVideo = document.getElementById('local-video'); if(localVideo) localVideo.srcObject = null;
        }

        window.toggleMic = () => {
            if(!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if(audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const btn = document.getElementById('mic-toggle-btn');
                if(audioTrack.enabled) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.classList.replace('text-red-500', 'text-[#e9edef]'); } 
                else { btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>'; btn.classList.replace('text-[#e9edef]', 'text-red-500'); }
            }
        };

        window.toggleCamera = () => {
            if(!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if(videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const btn = document.getElementById('cam-toggle-btn');
                if(videoTrack.enabled) { btn.innerHTML = '<i class="fa-solid fa-video"></i>'; btn.classList.replace('text-red-500', 'text-[#e9edef]'); } 
                else { btn.innerHTML = '<i class="fa-solid fa-video-slash"></i>'; btn.classList.replace('text-[#e9edef]', 'text-red-500'); }
            }
        };

        // Users and Contact Rendering
        function listenForUsers() {
            const usersRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users');
            onSnapshot(usersRef, (snapshot) => {
                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.mobile !== myMobile) { allUsers.push(data); setupLastMessageListener(data.mobile); }
                });
                renderContacts();
            });
        }

        function setupLastMessageListener(contactMobile) {
            if (chatListeners[contactMobile]) return; 
            const chatId = generateChatId(myMobile, contactMobile);
            const msgRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`);
            const q = query(msgRef, orderBy('timestamp', 'desc'), limit(1));
            
            chatListeners[contactMobile] = onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const newLatest = snapshot.docs[0].data();
                    const oldLatest = latestMessages[contactMobile];
                    
                    // ðŸ”¥ Background Message Notification & Sound
                    if (newLatest.senderMobile !== myMobile && (!oldLatest || newLatest.timestamp > oldLatest.timestamp) && newLatest.timestamp > appStartTime) {
                        try { document.getElementById('notification-sound').play(); } catch(e){}
                        
                        const senderInfo = allUsers.find(u => u.mobile === newLatest.senderMobile);
                        const senderName = senderInfo ? senderInfo.name : "Someone";
                        sendBackgroundNotification(`New message from ${senderName}`, newLatest.text || "Sent an attachment");
                    }
                    latestMessages[contactMobile] = newLatest;
                } else { latestMessages[contactMobile] = null; }
                renderContacts();
            });
        }

        function renderContacts() {
            const term = searchInput.value.toLowerCase();
            let filteredUsers = allUsers.filter(u => u.name.toLowerCase().includes(term) || u.mobile.includes(term));

            filteredUsers.sort((a, b) => {
                const timeA = latestMessages[a.mobile]?.timestamp || parseInt(a.lastActive) || 0;
                const timeB = latestMessages[b.mobile]?.timestamp || parseInt(b.lastActive) || 0;
                return timeB - timeA;
            });

            contactsContainer.innerHTML = '';
            if (filteredUsers.length === 0) { contactsContainer.innerHTML = `<p class="text-center text-[#8696a0] text-sm mt-10 p-6">No chats, contacts, or messages found.</p>`; return; }
            
            filteredUsers.forEach(user => {
                const isActive = activeContactMobile === user.mobile;
                const activeClass = isActive ? 'bg-[#2a3942]' : 'hover:bg-[#202c33]';
                
                const latestMsg = latestMessages[user.mobile];
                let msgPreview = "Tap to start chatting";
                let timeString = "";
                let isUnread = false;
                let previewClass = "text-[#8696a0]";

                if (latestMsg) {
                    const isMe = latestMsg.senderMobile === myMobile;
                    let tickClass = latestMsg.read ? "text-[#53bdeb]" : "text-[#8696a0]";
                    const prefix = isMe ? `<i class='fa-solid fa-check-double text-[12px] mr-1 ${tickClass}'></i> ` : "";
                    
                    if (latestMsg.text) msgPreview = prefix + escapeHTML(latestMsg.text);
                    else if (latestMsg.fileUrl) {
                        if (latestMsg.fileType?.startsWith('image/')) msgPreview = prefix + "<i class='fa-solid fa-camera mr-1'></i> Photo";
                        else if (latestMsg.fileType?.startsWith('video/')) msgPreview = prefix + "<i class='fa-solid fa-video mr-1'></i> Video";
                        else if (latestMsg.fileType?.startsWith('audio/')) msgPreview = prefix + "<i class='fa-solid fa-microphone mr-1'></i> Voice message";
                        else msgPreview = prefix + "<i class='fa-solid fa-file mr-1'></i> Document";
                    }
                    timeString = latestMsg.timeString || "";
                    const lastReadTime = parseInt(localStorage.getItem(`read_${user.mobile}`) || '0');
                    if (!isMe && latestMsg.timestamp > lastReadTime && !latestMsg.read) { isUnread = true; previewClass = "text-[#e9edef] font-semibold"; }
                }

                let unreadBadge = isUnread ? `<span class="bg-[#00a884] text-[#111b21] text-[11px] font-bold px-2 py-0.5 rounded-full ml-2">1</span>` : ``;
                
                if(user.typingTo === myMobile) {
                    msgPreview = "<span class='text-[#00a884] font-medium animate-pulse'>typing...</span>";
                    previewClass = ""; unreadBadge = ""; 
                }

                const userAvatar = getAvatarUrl(user.name, user.avatarUrl);

                const div = document.createElement('div');
                div.className = `flex items-center cursor-pointer transition-colors ${activeClass}`;
                div.onclick = () => openPrivateChat(user.name, user.mobile, userAvatar);
                
                div.innerHTML = `
                    <div class="px-3 py-3">
                        <img src="${userAvatar}" class="w-12 h-12 rounded-full object-cover">
                    </div>
                    <div class="flex-grow border-b border-[#222d34] pr-4 py-3 flex flex-col justify-center overflow-hidden">
                        <div class="flex justify-between items-center mb-0.5">
                            <h3 class="text-[17px] ${isUnread ? 'text-[#e9edef] font-semibold' : 'text-[#e9edef]'} truncate pr-2">${user.name}</h3>
                            <span class="text-xs ${isUnread ? 'text-[#00a884]' : 'text-[#8696a0]'} shrink-0">${timeString}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-[14px] ${previewClass} truncate w-full">${msgPreview}</p>
                            ${unreadBadge}
                        </div>
                    </div>
                `;
                contactsContainer.appendChild(div);
            });
        }

        searchInput.addEventListener('input', () => renderContacts());

        window.addEventListener('popstate', (event) => {
            if (activeContactMobile && window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('sidebar').classList.add('flex');
                document.getElementById('chat-area').classList.remove('flex'); document.getElementById('chat-area').classList.add('hidden');
                activeContactMobile = null; renderContacts();
                if(currentChatUnsubscribe) currentChatUnsubscribe(); if(userStatusUnsubscribe) userStatusUnsubscribe(); closeAllMenus();
            }
        });

        function closeChatLogic() {
            document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('sidebar').classList.add('flex');
            if (window.innerWidth < 768) {
                document.getElementById('chat-area').classList.remove('flex'); document.getElementById('chat-area').classList.add('hidden');
                if (window.location.hash === '#chat') history.replaceState(null, null, ' '); 
            } else { document.getElementById('empty-chat-state').classList.remove('hidden'); }
            activeContactMobile = null; renderContacts();
            if(currentChatUnsubscribe) currentChatUnsubscribe(); if(userStatusUnsubscribe) userStatusUnsubscribe(); closeAllMenus();
        }

        window.openPrivateChat = (contactName, contactMobile, contactAvatarUrl) => {
            activeContactMobile = contactMobile;
            localStorage.setItem(`read_${contactMobile}`, Date.now());
            
            document.getElementById('active-chat-name').innerText = contactName;
            document.getElementById('active-chat-avatar').src = contactAvatarUrl;
            document.getElementById('empty-chat-state').classList.add('hidden');
            
            if (window.innerWidth < 768) {
                if (!document.getElementById('sidebar').classList.contains('hidden')) history.pushState({ chatOpen: true }, "Chat", "#chat");
                document.getElementById('sidebar').classList.remove('flex'); document.getElementById('sidebar').classList.add('hidden'); 
                document.getElementById('chat-area').classList.remove('hidden'); document.getElementById('chat-area').classList.add('flex'); 
            } else { 
                document.getElementById('chat-area').classList.remove('hidden'); document.getElementById('chat-area').classList.add('flex'); 
            }

            renderContacts();
            document.querySelectorAll('.pvt-msg').forEach(e => e.remove());

            if(userStatusUnsubscribe) userStatusUnsubscribe();
            userStatusUnsubscribe = onSnapshot(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', contactMobile), (docSnap) => {
                const statusElem = document.getElementById('active-chat-status');
                if(docSnap.exists()){
                    const uData = docSnap.data();
                    if(uData.avatarUrl) document.getElementById('active-chat-avatar').src = getAvatarUrl(contactName, uData.avatarUrl);

                    if(uData.typingTo === myMobile) {
                        statusElem.innerText = 'typing...'; statusElem.className = 'text-[13px] text-[#00a884] font-medium animate-pulse';
                    } else {
                        const isOnline = (Date.now() - uData.lastActive) < 120000;
                        statusElem.innerText = isOnline ? 'online' : 'offline';
                        statusElem.className = 'text-[13px] text-[#8696a0]';
                    }
                }
            });

            if (currentChatUnsubscribe) currentChatUnsubscribe();
            const chatId = generateChatId(myMobile, contactMobile);
            const msgRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`);
            const q = query(msgRef, orderBy('timestamp', 'asc'), limit(200));

            currentChatUnsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const mData = change.doc.data();
                    if (!mData.read && mData.senderMobile !== myMobile) { updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`, change.doc.id), { read: true }); }
                    
                    // Call the modified render element
                    if (change.type === "added") msgBox.appendChild(createMessageElement(change.doc.id, mData, contactName));
                    else if (change.type === "modified") {
                        const oldNode = document.getElementById(`msg-${change.doc.id}`);
                        if(oldNode) oldNode.replaceWith(createMessageElement(change.doc.id, mData, contactName));
                    } 
                    else if (change.type === "removed") {
                        const msgDiv = document.getElementById(`msg-${change.doc.id}`);
                        if(msgDiv) msgDiv.remove();
                    }
                });
                localStorage.setItem(`read_${activeContactMobile}`, Date.now()); renderContacts();
                setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 100);
            });
        };

        window.closeChatMobile = () => { if (window.innerWidth < 768 && window.location.hash === '#chat') history.back(); else closeChatLogic(); };
        
        window.toggleReactionMenu = (docId, e) => {
            e.stopPropagation(); if(e.target.closest('button')) return; 
            const menu = document.getElementById(`react-menu-${docId}`);
            const isHidden = menu.classList.contains('hidden');
            closeAllMenus();
            if(isHidden) menu.classList.remove('hidden');
        };
        window.addReaction = async (docId, emoji, e) => { if(e) e.stopPropagation(); closeAllMenus(); try { await updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`, docId), { reaction: emoji }); } catch(e){} };
        window.removeReaction = async (docId, e) => { if(e) e.stopPropagation(); try { await updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`, docId), { reaction: null }); } catch(e){} };
        window.deleteMsg = async (docId, e) => { if(e) e.stopPropagation(); closeAllMenus(); if(confirm("Delete message for everyone?")) { try { await deleteDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`, docId)); } catch(e){} } };

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if ((!text && !selectedFile) || !activeContactMobile) return;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xl"></i>';
            setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { typingTo: null }, { merge: true });

            try {
                let fileUrl = null, fileName = null, fileType = null;
                if (selectedFile) {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const uploadResult = await response.json();
                    if(uploadResult.secure_url) { fileUrl = uploadResult.secure_url; fileName = selectedFile.name; fileType = selectedFile.type || 'audio/mp3'; } 
                    else throw new Error("Cloudinary failed");
                }

                await addDoc(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`), {
                    text: text, senderMobile: myMobile, timestamp: Date.now(),
                    timeString: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    fileUrl: fileUrl, fileName: fileName, fileType: fileType, reaction: null, read: false 
                });

                msgInput.value = ''; clearFile();
                msgInput.style.height = '40px'; toggleInputButtons();
                localStorage.setItem(`read_${activeContactMobile}`, Date.now()); msgInput.focus();
            } catch (error) { alert("Message failed."); } 
            finally { sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane text-xl ml-[-2px]"></i>'; sendBtn.disabled = msgInput.value.trim() === '' && !selectedFile; }
        };

        // ðŸ”¥ Custom Audio Logic ðŸ”¥
        window.toggleCustomAudio = (id, btn) => {
            const audio = document.getElementById(id);
            const icon = btn.querySelector('i');
            if (audio.paused) {
                document.querySelectorAll('audio').forEach(a => {
                    if(a.id !== id && a.id.startsWith('audio_pvt_')) {
                        a.pause();
                        const otherBtn = document.getElementById('btn_'+a.id);
                        if(otherBtn) { otherBtn.querySelector('i').className = 'fa-solid fa-play'; }
                    }
                });
                audio.play();
                icon.className = 'fa-solid fa-pause';
            } else {
                audio.pause();
                icon.className = 'fa-solid fa-play';
            }
        };
        window.updateAudioProgress = (id, audio) => {
            const slider = document.getElementById('slider_'+id);
            const timeDisplay = document.getElementById('time_'+id);
            if(audio.duration && slider) {
                slider.value = (audio.currentTime / audio.duration) * 100;
                timeDisplay.innerText = formatTime(audio.currentTime);
            }
        };
        window.seekAudio = (id, slider) => {
            const audio = document.getElementById(id);
            if(audio.duration) audio.currentTime = (slider.value / 100) * audio.duration;
        };
        window.audioEnded = (id, audio) => {
            const btn = document.getElementById('btn_'+id);
            if(btn) btn.querySelector('i').className = 'fa-solid fa-play';
            const slider = document.getElementById('slider_'+id);
            if(slider) slider.value = 0;
            const timeDisplay = document.getElementById('time_'+id);
            if(timeDisplay) timeDisplay.innerText = formatTime(audio.duration || 0);
        };
        window.initAudioDuration = (id, audio) => {
            const timeDisplay = document.getElementById('time_'+id);
            if(timeDisplay) timeDisplay.innerText = formatTime(audio.duration);
        };

        function getDownloadableUrl(originalUrl) { return originalUrl && originalUrl.includes('/upload/') ? originalUrl.replace('/upload/', '/upload/fl_attachment/') : originalUrl; }

        function createMessageElement(docId, data, contactName) {
            const isMe = data.senderMobile === myMobile;
            const bubbleClasses = isMe ? 'bg-[#005c4b] self-end rounded-tr-sm' : 'bg-[#202c33] self-start rounded-tl-sm';
            
            const msgDiv = document.createElement('div');
            msgDiv.id = `msg-${docId}`;
            const bottomMargin = data.reaction ? 'mb-6' : 'mb-1';
            msgDiv.className = `pvt-msg flex flex-col max-w-[85%] md:max-w-[65%] ${bubbleClasses} p-2 rounded-xl ${bottomMargin} relative shadow-sm cursor-pointer select-none group`;
            msgDiv.onclick = (e) => toggleReactionMenu(docId, e);
            
            let content = '';
            
            if (data.fileUrl) {
                // ðŸ”¥ NEW WHATSAPP STYLE AUDIO UI ðŸ”¥
                if (data.fileType && data.fileType.startsWith('audio/')) {
                    const audioId = `audio_pvt_${docId}`;
                    const avatarForAudio = isMe ? getAvatarUrl(myName, myAvatarUrl) : document.getElementById('active-chat-avatar').src;
                    const micColor = isMe ? (data.read ? 'text-[#53bdeb]' : 'text-[#8696a0]') : 'text-[#00a884]';
                    
                    content = `
                    <div class="flex items-center gap-3 w-56 md:w-64 pt-1 pb-2">
                        <div class="relative shrink-0">
                            <img src="${avatarForAudio}" class="w-12 h-12 rounded-full object-cover">
                            <div class="absolute -bottom-1 -right-1 bg-[#202c33] rounded-full p-1 border-2 border-[${isMe ? '#005c4b' : '#202c33'}]">
                                <i class="fa-solid fa-microphone ${micColor} text-[10px]"></i>
                            </div>
                        </div>
                        <button id="btn_${audioId}" onclick="toggleCustomAudio('${audioId}', this); event.stopPropagation();" class="text-3xl text-[#aebac1] hover:text-white transition-colors w-8 text-left">
                            <i class="fa-solid fa-play"></i>
                        </button>
                        <div class="flex flex-col flex-grow relative top-1">
                            <input type="range" id="slider_${audioId}" min="0" max="100" value="0" class="audio-slider w-full" oninput="seekAudio('${audioId}', this); event.stopPropagation();" onclick="event.stopPropagation();">
                            <div class="flex justify-between items-center mt-1">
                                <span id="time_${audioId}" class="text-[11px] text-[#8696a0]">0:00</span>
                            </div>
                        </div>
                        <audio id="${audioId}" src="${data.fileUrl}" preload="metadata" onloadedmetadata="initAudioDuration('${audioId}', this)" ontimeupdate="updateAudioProgress('${audioId}', this)" onended="audioEnded('${audioId}', this)"></audio>
                    </div>`;
                } 
                else if (data.fileType && data.fileType.startsWith('video/')) {
                    content = `<video controls class="rounded-lg mb-1 max-h-64 w-full object-cover bg-black/40"><source src="${data.fileUrl}"></video>`;
                } else if (data.fileType && data.fileType.startsWith('image/')) {
                    content = `<img src="${data.fileUrl}" class="rounded-lg mb-1 max-h-64 w-full object-cover cursor-pointer" onclick="openLightbox('${data.fileUrl}', event)">`;
                } else {
                    const forcedDownloadUrl = getDownloadableUrl(data.fileUrl);
                    content = `<a href="${forcedDownloadUrl}" download="${data.fileName}" target="_blank" class="bg-black/20 p-3 rounded-lg flex items-center gap-3 text-sm mb-1 border border-white/5 w-full">
                        <i class="fa-solid fa-file-arrow-down text-2xl ${isMe ? 'text-[#00a884]' : 'text-pink-400'} shrink-0"></i> 
                        <span class="truncate font-medium text-[#e9edef]">${data.fileName}</span>
                    </a>`;
                }
            }
            
            let finalHtmlText = data.text ? `<p class="text-[15px] whitespace-pre-wrap leading-relaxed px-1 text-[#e9edef] mt-1">${escapeHTML(data.text)}</p>` : '';
            let reactionBadge = data.reaction ? `<div class="absolute -bottom-4 ${isMe ? 'right-2' : 'left-2'} bg-[#233138] border border-[#222d34] rounded-full px-2 py-0.5 text-xs shadow-lg z-10 hover:bg-slate-700 transition-colors" onclick="removeReaction('${docId}', event)" title="Remove reaction">${data.reaction}</div>` : '';

            let popupMenu = `
                <div id="react-menu-${docId}" class="reaction-menu-popup hidden absolute ${isMe ? 'right-0' : 'left-0'} -top-12 bg-[#233138] border border-[#222d34] rounded-full flex items-center gap-2 px-3 py-1.5 shadow-2xl z-[60] min-w-max">
                    <button onclick="addReaction('${docId}', 'ðŸ‘', event)" class="hover:scale-125 transition-all text-xl">ðŸ‘</button>
                    <button onclick="addReaction('${docId}', 'â¤ï¸', event)" class="hover:scale-125 transition-all text-xl">â¤ï¸</button>
                    <button onclick="addReaction('${docId}', 'ðŸ˜‚', event)" class="hover:scale-125 transition-all text-xl">ðŸ˜‚</button>
                    <button onclick="addReaction('${docId}', 'ðŸ˜¢', event)" class="hover:scale-125 transition-all text-xl">ðŸ˜¢</button>
                    ${isMe ? `<div class="w-[1px] h-5 bg-white/10 mx-1"></div><button onclick="deleteMsg('${docId}', event)" class="hover:scale-125 transition-all text-red-500 text-lg"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            `;

            let tickColor = data.read ? "text-[#53bdeb]" : "text-[#8696a0]";
            // If it is an audio message, ticks are shown differently or hidden inside the time bar usually, but we keep it bottom right for consistency
            let ticksHtml = isMe ? `<i class="fa-solid fa-check-double text-[12px] ${tickColor} ml-1"></i>` : '';
            
            // Adjust margin if text exists vs only media
            let timeMargin = (data.text || !data.fileUrl) ? "mt-1 float-right" : "absolute bottom-2 right-2 bg-black/40 px-1.5 rounded-full backdrop-blur-sm";

            msgDiv.innerHTML = `
                ${popupMenu}
                ${content}
                ${finalHtmlText}
                <div class="flex items-center justify-end px-1 ${timeMargin}">
                    <span class="text-[11px] text-[#8696a0]">${data.timeString}</span>
                    ${ticksHtml}
                </div>
                ${reactionBadge}
            `;
            return msgDiv;
        }

        function escapeHTML(str) { return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }
    </script>
</body>
</html>
