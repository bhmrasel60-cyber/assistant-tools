<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RasBook | Social Media</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f2f5; 
            overflow-x: hidden;
        }

        .fb-blue { color: #1877f2; }
        .bg-fb-blue { background-color: #1877f2; }
        .hover-bg-fb:hover { background-color: #f2f2f2; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 10px; }
        
        .story-card {
            min-width: 110px; height: 200px;
            background-size: cover; background-position: center;
            border-radius: 12px; position: relative; cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .story-card:hover { transform: scale(1.02); }

        /* Login Background */
        .login-bg { background-color: #f0f2f5; }
    </style>
</head>
<body>

    <div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center login-bg">
        <div class="flex flex-col md:flex-row items-center w-full max-w-5xl p-6">
            <div class="md:w-1/2 mb-10 md:mb-0 md:pr-10 text-center md:text-left">
                <h1 class="text-5xl md:text-6xl font-bold fb-blue mb-4">RasBook</h1>
                <p class="text-2xl text-gray-700 leading-snug">Connect with friends and the world around you on RasBook.</p>
            </div>
            <div class="md:w-1/2 w-full max-w-md">
                <div class="bg-white p-4 rounded-lg shadow-xl border border-gray-200">
                    <form id="auth-form" class="space-y-4">
                        <input type="text" id="reg-name" required class="w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-lg" placeholder="Full Name">
                        <input type="tel" id="reg-mobile" required pattern="[0-9]{11}" class="w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-lg" placeholder="Mobile Number (11 digits)">
                        <input type="password" id="reg-password" required minlength="6" maxlength="6" class="w-full border border-gray-300 rounded-md p-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-lg" placeholder="6-digit PIN Password">
                        <button type="submit" id="auth-btn" class="w-full bg-fb-blue text-white font-bold text-xl py-3 rounded-md hover:bg-blue-600 transition-colors">Log In / Sign Up</button>
                    </form>
                    <div class="border-t border-gray-300 my-4"></div>
                    <div class="text-center">
                        <button class="bg-[#42b72a] hover:bg-[#36a420] text-white font-bold py-3 px-6 rounded-md text-lg transition-colors">Create new account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex-col h-screen overflow-hidden">
        
        <nav class="bg-white shadow-sm h-[56px] w-full fixed top-0 z-50 flex items-center justify-between px-4">
            <div class="flex items-center gap-2 w-1/4">
                <div class="w-10 h-10 rounded-full bg-fb-blue text-white flex items-center justify-center text-2xl font-bold cursor-pointer"><i class="fa-brands fa-facebook-f mt-1"></i></div>
                <div class="hidden md:flex items-center bg-gray-100 rounded-full px-3 py-2 w-64">
                    <i class="fa-solid fa-magnifying-glass text-gray-500"></i>
                    <input type="text" placeholder="Search RasBook" class="bg-transparent border-none outline-none ml-2 w-full text-sm">
                </div>
            </div>

            <div class="hidden md:flex items-center justify-center gap-2 w-2/4 h-full">
                <button class="w-24 h-full flex items-center justify-center border-b-4 border-blue-500 text-blue-500 text-2xl hover-bg-fb transition-colors"><i class="fa-solid fa-house"></i></button>
                <button class="w-24 h-full flex items-center justify-center border-b-4 border-transparent text-gray-500 hover:bg-gray-100 rounded-lg my-1 text-2xl transition-colors"><i class="fa-solid fa-user-group"></i></button>
                <button class="w-24 h-full flex items-center justify-center border-b-4 border-transparent text-gray-500 hover:bg-gray-100 rounded-lg my-1 text-2xl transition-colors"><i class="fa-solid fa-video"></i></button>
                <button class="w-24 h-full flex items-center justify-center border-b-4 border-transparent text-gray-500 hover:bg-gray-100 rounded-lg my-1 text-2xl transition-colors"><i class="fa-solid fa-shop"></i></button>
            </div>

            <div class="flex items-center justify-end gap-2 w-1/4">
                <button class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl transition-colors"><i class="fa-solid fa-bars"></i></button>
                <button class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl transition-colors"><i class="fa-brands fa-facebook-messenger"></i></button>
                <button class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl transition-colors"><i class="fa-solid fa-bell"></i></button>
                <img id="nav-avatar" src="" class="w-10 h-10 rounded-full cursor-pointer border border-gray-200 object-cover" onclick="logoutApp()" title="Click to Logout">
            </div>
        </nav>

        <div class="flex justify-between w-full h-full pt-[56px] overflow-hidden">
            
            <div class="hidden lg:flex flex-col w-[360px] p-4 overflow-y-auto custom-scroll hover-scroll gap-2">
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full object-cover">
                    <span id="sidebar-name" class="font-semibold text-[15px]">User Name</span>
                </div>
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <i class="fa-solid fa-user-group text-blue-500 text-2xl w-8 text-center"></i><span class="font-semibold text-[15px]">Friends</span>
                </div>
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <i class="fa-solid fa-clock-rotate-left text-blue-500 text-2xl w-8 text-center"></i><span class="font-semibold text-[15px]">Memories</span>
                </div>
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <i class="fa-solid fa-bookmark text-purple-500 text-2xl w-8 text-center"></i><span class="font-semibold text-[15px]">Saved</span>
                </div>
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <i class="fa-solid fa-users text-blue-500 text-2xl w-8 text-center"></i><span class="font-semibold text-[15px]">Groups</span>
                </div>
                <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors">
                    <i class="fa-solid fa-video text-blue-500 text-2xl w-8 text-center"></i><span class="font-semibold text-[15px]">Video</span>
                </div>
                <div class="border-b border-gray-300 my-2"></div>
            </div>

            <div class="w-full lg:w-[680px] flex-shrink-0 mx-auto overflow-y-auto custom-scroll p-4 pb-20">
                
                <div class="flex gap-2 overflow-x-auto custom-scroll pb-2 mb-4">
                    <div class="story-card flex-shrink-0 flex flex-col justify-between overflow-hidden bg-white border border-gray-200">
                        <img id="story-my-avatar" src="" class="w-full h-32 object-cover transition-transform hover:scale-105">
                        <div class="relative flex flex-col items-center justify-end h-full pb-2">
                            <div class="absolute -top-5 w-10 h-10 bg-fb-blue rounded-full border-4 border-white flex items-center justify-center text-white text-xl"><i class="fa-solid fa-plus"></i></div>
                            <span class="text-[13px] font-semibold mt-5">Create story</span>
                        </div>
                    </div>
                    <div class="story-card flex-shrink-0 p-3" style="background-image: url('https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=300&q=80');">
                        <div class="w-10 h-10 rounded-full border-4 border-blue-500 overflow-hidden"><img src="https://ui-avatars.com/api/?name=Fahim&background=random" class="w-full h-full object-cover"></div>
                        <span class="absolute bottom-2 left-3 text-white font-semibold text-sm drop-shadow-md">Fahim</span>
                    </div>
                    <div class="story-card flex-shrink-0 p-3" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=300&q=80');">
                        <div class="w-10 h-10 rounded-full border-4 border-blue-500 overflow-hidden"><img src="https://ui-avatars.com/api/?name=Samirul&background=random" class="w-full h-full object-cover"></div>
                        <span class="absolute bottom-2 left-3 text-white font-semibold text-sm drop-shadow-md">Samirul</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                    <div class="flex gap-2 mb-3">
                        <img id="create-post-avatar" src="" class="w-10 h-10 rounded-full object-cover">
                        <div class="bg-gray-100 hover:bg-gray-200 cursor-pointer rounded-full flex-grow px-4 flex items-center transition-colors" onclick="openPostModal()">
                            <span class="text-gray-500 text-[17px]">What's on your mind, <span id="mind-name"></span>?</span>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 mb-3"></div>
                    <div class="flex justify-between items-center px-2">
                        <button onclick="openPostModal()" class="flex-1 flex items-center justify-center gap-2 hover:bg-gray-100 py-2 rounded-lg font-semibold text-gray-600 transition-colors">
                            <i class="fa-solid fa-video text-red-500 text-xl"></i> Live video
                        </button>
                        <button onclick="openPostModal()" class="flex-1 flex items-center justify-center gap-2 hover:bg-gray-100 py-2 rounded-lg font-semibold text-gray-600 transition-colors">
                            <i class="fa-solid fa-images text-green-500 text-xl"></i> Photo/video
                        </button>
                        <button onclick="openPostModal()" class="hidden md:flex flex-1 items-center justify-center gap-2 hover:bg-gray-100 py-2 rounded-lg font-semibold text-gray-600 transition-colors">
                            <i class="fa-regular fa-face-smile text-yellow-500 text-xl"></i> Feeling/activity
                        </button>
                    </div>
                </div>

                <div id="posts-container" class="flex flex-col gap-4">
                    <div class="text-center text-gray-500 mt-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i> Loading feed...</div>
                </div>

            </div>

            <div class="hidden lg:flex flex-col w-[360px] p-4 overflow-y-auto custom-scroll">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="font-semibold text-gray-500 text-[17px]">Contacts</h3>
                    <div class="flex gap-4 text-gray-500">
                        <i class="fa-solid fa-video cursor-pointer hover:bg-gray-200 p-2 rounded-full"></i>
                        <i class="fa-solid fa-magnifying-glass cursor-pointer hover:bg-gray-200 p-2 rounded-full"></i>
                        <i class="fa-solid fa-ellipsis cursor-pointer hover:bg-gray-200 p-2 rounded-full"></i>
                    </div>
                </div>
                <div id="contacts-list" class="flex flex-col gap-1">
                    </div>
            </div>
        </div>
    </div>

    <div id="create-post-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-white/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-[500px] border border-gray-300 flex flex-col relative animate-[popIn_0.2s_ease-out]">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <div class="w-8"></div>
                <h2 class="text-xl font-bold">Create post</h2>
                <button onclick="closePostModal()" class="w-9 h-9 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="post-form" class="flex flex-col p-4">
                <div class="flex items-center gap-3 mb-4">
                    <img id="modal-avatar" src="" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h3 id="modal-name" class="font-semibold text-[15px]">Name</h3>
                        <div class="bg-gray-200 px-2 py-0.5 rounded-md text-[12px] font-semibold flex items-center gap-1 w-max cursor-pointer">
                            <i class="fa-solid fa-user-group text-[10px]"></i> Friends <i class="fa-solid fa-caret-down"></i>
                        </div>
                    </div>
                </div>

                <textarea id="post-text" rows="4" class="w-full text-xl outline-none resize-none placeholder-gray-500 mb-2" placeholder="What's on your mind?"></textarea>
                
                <div id="image-preview-container" class="hidden relative mb-4">
                    <img id="post-image-preview" src="" class="w-full rounded-lg border border-gray-200 object-cover max-h-64">
                    <button type="button" onclick="removePostImage()" class="absolute top-2 right-2 w-8 h-8 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="border border-gray-300 rounded-lg p-3 flex justify-between items-center mb-4 shadow-sm cursor-pointer hover:bg-gray-50" onclick="document.getElementById('post-image-input').click()">
                    <span class="font-semibold">Add to your post</span>
                    <div class="flex gap-4 text-2xl">
                        <i class="fa-solid fa-images text-green-500"></i>
                        <i class="fa-solid fa-user-tag text-blue-500"></i>
                        <i class="fa-regular fa-face-smile text-yellow-500"></i>
                        <i class="fa-solid fa-location-dot text-red-500"></i>
                    </div>
                </div>
                <input type="file" id="post-image-input" accept="image/*" class="hidden">

                <button type="submit" id="post-submit-btn" class="w-full bg-fb-blue text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, onSnapshot, query, orderBy, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SYNC_APP_ID = "rasel-fb-clone-app"; // New collection path for FB clone

        // Cloudinary for Image Uploads
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/de2w78yxh/auto/upload"; 
        const CLOUDINARY_UPLOAD_PRESET = "ml_default"; 

        // State variables
        let myName = localStorage.getItem('fb_name') || '';
        let myMobile = localStorage.getItem('fb_mobile') || '';
        let myPassword = localStorage.getItem('fb_pass') || '';
        let myAvatar = '';
        let allUsers = [];
        let selectedPostImage = null;

        function getAvatarUrl(name) { return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1877f2&color=fff&bold=true`; }
        function hashPassword(password) { return CryptoJS.SHA256(password).toString(); }

        // === Auth & Init ===
        if (myName && myMobile && myPassword) {
            myAvatar = getAvatarUrl(myName);
            startApp();
        }

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const n = document.getElementById('reg-name').value.trim();
            const m = document.getElementById('reg-mobile').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            const btn = document.getElementById('auth-btn');

            if (n && m.length === 11 && p.length >= 6) {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                const hashedPass = hashPassword(p);
                try {
                    await signInAnonymously(auth);
                    const userRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'users', m);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const dbData = userSnap.data();
                        if (!dbData.password) await updateDoc(userRef, { password: hashedPass, name: n });
                        else if (dbData.password !== hashedPass) { alert("Wrong password!"); btn.innerHTML = 'Log In / Sign Up'; return; }
                    } else {
                        await setDoc(userRef, { name: n, mobile: m, password: hashedPass, lastActive: Date.now() });
                    }
                    
                    myName = n; myMobile = m; myPassword = hashedPass; myAvatar = getAvatarUrl(n);
                    localStorage.setItem('fb_name', n); localStorage.setItem('fb_mobile', m); localStorage.setItem('fb_pass', hashedPass);
                    document.getElementById('login-modal').classList.add('hidden');
                    startApp();
                } catch(err) { alert("Error connecting: " + err.message); btn.innerHTML = 'Log In / Sign Up'; }
            }
        };

        async function startApp() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            
            // Set Avatars
            document.getElementById('nav-avatar').src = myAvatar;
            document.getElementById('sidebar-avatar').src = myAvatar;
            document.getElementById('story-my-avatar').src = myAvatar;
            document.getElementById('create-post-avatar').src = myAvatar;
            document.getElementById('modal-avatar').src = myAvatar;
            document.getElementById('sidebar-name').innerText = myName;
            document.getElementById('mind-name').innerText = myName.split(' ')[0];
            document.getElementById('modal-name').innerText = myName;

            await signInAnonymously(auth);
            
            // Active Status Update
            setInterval(() => updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'users', myMobile), { lastActive: Date.now() }).catch(()=>{}), 60000);

            // Listen to Users (for Right Sidebar Contacts)
            onSnapshot(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'users'), (snap) => {
                allUsers = [];
                const contactsList = document.getElementById('contacts-list');
                contactsList.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    if(u.mobile !== myMobile) {
                        allUsers.push(u);
                        const isOnline = (Date.now() - (u.lastActive || 0)) < 120000;
                        contactsList.innerHTML += `
                            <div class="flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors relative">
                                <div class="relative">
                                    <img src="${getAvatarUrl(u.name)}" class="w-9 h-9 rounded-full">
                                    ${isOnline ? '<div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                                </div>
                                <span class="font-medium text-[15px]">${u.name}</span>
                            </div>`;
                    }
                });
            });

            // Listen to Posts (Realtime Feed)
            listenToPosts();
        }

        window.logoutApp = () => { if(confirm("Are you sure you want to log out?")) { localStorage.clear(); location.reload(); } }

        // === Post Creation Logic ===
        window.openPostModal = () => { document.getElementById('create-post-modal').classList.remove('hidden'); document.getElementById('post-text').focus(); }
        window.closePostModal = () => { document.getElementById('create-post-modal').classList.add('hidden'); document.getElementById('post-form').reset(); removePostImage(); }
        
        document.getElementById('post-image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                selectedPostImage = file;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById('post-image-preview').src = ev.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        window.removePostImage = () => {
            selectedPostImage = null; document.getElementById('post-image-input').value = '';
            document.getElementById('image-preview-container').classList.add('hidden'); document.getElementById('post-image-preview').src = '';
        }

        async function uploadImage(file) {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await res.json();
            return data.secure_url;
        }

        document.getElementById('post-form').onsubmit = async (e) => {
            e.preventDefault();
            const text = document.getElementById('post-text').value.trim();
            if(!text && !selectedPostImage) return;

            const btn = document.getElementById('post-submit-btn');
            const ogText = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Posting...';

            let imgUrl = null;
            if(selectedPostImage) {
                try { imgUrl = await uploadImage(selectedPostImage); } catch(err) { alert("Image upload failed"); btn.disabled = false; btn.innerHTML = ogText; return; }
            }

            const newPost = {
                authorName: myName, authorMobile: myMobile, authorAvatar: myAvatar,
                content: text, imageUrl: imgUrl, timestamp: Date.now(),
                likes: [], comments: []
            };

            try {
                await addDoc(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'posts'), newPost);
                closePostModal();
            } catch(e) { alert("Failed to post"); }
            finally { btn.disabled = false; btn.innerHTML = ogText; }
        };

        // === Feed Logic ===
        function timeAgo(timestamp) {
            const seconds = Math.floor((new Date() - timestamp) / 1000);
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " y";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " m";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " d";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " h";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " min";
            return "Just now";
        }

        function listenToPosts() {
            onSnapshot(query(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'posts'), orderBy('timestamp', 'desc')), (snap) => {
                const container = document.getElementById('posts-container');
                container.innerHTML = '';
                
                if(snap.empty) { container.innerHTML = '<p class="text-center text-gray-500 mt-10">No posts yet. Be the first to post!</p>'; return; }

                snap.forEach(docSnap => {
                    const post = docSnap.data();
                    const postId = docSnap.id;
                    const hasLiked = post.likes && post.likes.includes(myMobile);
                    const likeIconColor = hasLiked ? 'text-blue-600' : 'text-gray-500';
                    const likeText = hasLiked ? 'text-blue-600 font-semibold' : 'text-gray-500 font-semibold';

                    // Comments HTML
                    let commentsHtml = '';
                    if(post.comments && post.comments.length > 0) {
                        commentsHtml = `<div class="mt-3 border-t border-gray-200 pt-3 space-y-2">`;
                        // Show max 3 comments
                        post.comments.slice(-3).forEach(c => {
                            commentsHtml += `
                                <div class="flex gap-2">
                                    <img src="${getAvatarUrl(c.name)}" class="w-8 h-8 rounded-full">
                                    <div class="bg-gray-100 rounded-2xl px-3 py-1.5 max-w-[85%]">
                                        <h4 class="font-semibold text-[13px] leading-tight">${c.name}</h4>
                                        <p class="text-[14px] leading-tight text-gray-800">${c.text}</p>
                                    </div>
                                </div>`;
                        });
                        commentsHtml += `</div>`;
                    }

                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                    postEl.innerHTML = `
                        <div class="flex justify-between items-center p-4 pb-2">
                            <div class="flex gap-2 items-center">
                                <img src="${post.authorAvatar || getAvatarUrl(post.authorName)}" class="w-10 h-10 rounded-full cursor-pointer">
                                <div>
                                    <h3 class="font-semibold text-[15px] hover:underline cursor-pointer">${post.authorName}</h3>
                                    <div class="flex items-center text-gray-500 text-[12px] gap-1">
                                        <span>${timeAgo(post.timestamp)}</span> â€¢ <i class="fa-solid fa-earth-americas"></i>
                                    </div>
                                </div>
                            </div>
                            <button class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500 transition-colors"><i class="fa-solid fa-ellipsis"></i></button>
                        </div>
                        
                        ${post.content ? `<div class="px-4 pb-2 text-[15px] whitespace-pre-wrap">${post.content}</div>` : ''}
                        ${post.imageUrl ? `<img src="${post.imageUrl}" class="w-full max-h-[500px] object-cover border-y border-gray-200 cursor-pointer">` : ''}
                        
                        <div class="px-4 py-2 flex justify-between items-center text-gray-500 text-[13px] border-b border-gray-200 mx-2">
                            <div class="flex items-center gap-1">
                                <div class="w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center text-white text-[10px]"><i class="fa-solid fa-thumbs-up"></i></div>
                                <span>${post.likes ? post.likes.length : 0}</span>
                            </div>
                            <div>
                                <span class="cursor-pointer hover:underline">${post.comments ? post.comments.length : 0} comments</span>
                            </div>
                        </div>

                        <div class="flex justify-between px-4 py-1">
                            <button onclick="toggleLike('${postId}', ${hasLiked})" class="flex-1 flex justify-center items-center gap-2 py-1.5 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fa-solid fa-thumbs-up ${likeIconColor} text-xl"></i> <span class="${likeText}">Like</span>
                            </button>
                            <button onclick="focusComment('${postId}')" class="flex-1 flex justify-center items-center gap-2 py-1.5 hover:bg-gray-100 rounded-lg transition-colors text-gray-500 font-semibold">
                                <i class="fa-regular fa-message text-xl"></i> Comment
                            </button>
                            <button class="flex-1 flex justify-center items-center gap-2 py-1.5 hover:bg-gray-100 rounded-lg transition-colors text-gray-500 font-semibold">
                                <i class="fa-solid fa-share text-xl"></i> Share
                            </button>
                        </div>

                        <div class="px-4 pb-3">
                            ${commentsHtml}
                            <form onsubmit="postComment(event, '${postId}')" class="flex gap-2 mt-3">
                                <img src="${myAvatar}" class="w-8 h-8 rounded-full">
                                <div class="flex-grow relative">
                                    <input type="text" id="comment-input-${postId}" required placeholder="Write a comment..." class="w-full bg-gray-100 hover:bg-gray-200 focus:bg-gray-100 transition-colors rounded-full px-4 py-1.5 outline-none text-[15px]">
                                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-700 p-1"><i class="fa-solid fa-paper-plane"></i></button>
                                </div>
                            </form>
                        </div>
                    `;
                    container.appendChild(postEl);
                });
            });
        }

        // === Actions Logic ===
        window.toggleLike = async (postId, currentlyLiked) => {
            const postRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'posts', postId);
            if(currentlyLiked) {
                await updateDoc(postRef, { likes: arrayRemove(myMobile) });
            } else {
                await updateDoc(postRef, { likes: arrayUnion(myMobile) });
            }
        };

        window.focusComment = (postId) => {
            document.getElementById(`comment-input-${postId}`).focus();
        };

        window.postComment = async (e, postId) => {
            e.preventDefault();
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if(!text) return;

            input.value = ''; // clear instantly for good UX
            const newComment = {
                name: myName, mobile: myMobile, text: text, timestamp: Date.now()
            };

            const postRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'posts', postId);
            await updateDoc(postRef, { comments: arrayUnion(newComment) });
        };

    </script>
</body>
</html>
